{
  "active": true,
  "connections": {
    "ChatInput": {
      "main": [
        [
          {
            "node": "Prompt For Gibberish check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Employees Regex": {
      "main": [
        [
          {
            "node": "Senority Regex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Typos": {
      "main": [
        [
          {
            "node": "Employees Regex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt - Fix Typos": {
      "main": [
        [
          {
            "node": "Fix Typos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qwen3 30b": {
      "ai_languageModel": [
        [
          {
            "node": "Fix Typos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Senority Regex": {
      "main": [
        [
          {
            "node": "Roles Regex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Prompt for Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VLLM2": {
      "ai_languageModel": [
        [
          {
            "node": "Response in JSON",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate SQL Query": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON": {
      "ai_outputParser": [
        [
          {
            "node": "Fix Typos",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Roles Regex": {
      "main": [
        [
          {
            "node": "Skills Regex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skills Regex": {
      "main": [
        [
          {
            "node": "Industries Regex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Knobs": {
      "main": [
        [
          {
            "node": "Generate SQL Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Response in JSON",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "JSON to Markdown": {
      "main": [
        []
      ]
    },
    "Prompt for Reponse": {
      "main": [
        [
          {
            "node": "Response in JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response in JSON": {
      "main": [
        [
          {
            "node": "JSON to Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response in Markdown": {
      "main": [
        [
          {
            "node": "Send Slack Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VLLM": {
      "ai_languageModel": [
        [
          {
            "node": "Response in Markdown",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Industries Regex": {
      "main": [
        [
          {
            "node": "Knobs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "If not a bot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If not a bot": {
      "main": [
        [
          {
            "node": "Authorised?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Request": {
      "main": [
        [
          {
            "node": "ChatInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt for Markdown": {
      "main": [
        [
          {
            "node": "Response in Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack Response": {
      "main": [
        [
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        []
      ]
    },
    "Random response1": {
      "main": [
        [
          {
            "node": "Send Slack Response - Gibberish1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt For Gibberish check": {
      "main": [
        [
          {
            "node": "Check gibberish",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qwen3 30b1": {
      "ai_languageModel": [
        [
          {
            "node": "Check gibberish",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "JSON1": {
      "ai_outputParser": [
        [
          {
            "node": "Check gibberish",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Check gibberish": {
      "main": [
        [
          {
            "node": "Is clean?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is clean?": {
      "main": [
        [
          {
            "node": "Prompt - Fix Typos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Random response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Authorised?": {
      "main": [
        [
          {
            "node": "Authorised?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Authorised?1": {
      "main": [
        [
          {
            "node": "Format Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unauthorised",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unauthorised",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search": {
      "main": [
        [
          {
            "node": "Proces rest api input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Generate Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Ganttic Properties": {
      "main": [
        [
          {
            "node": "Get Properties",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Properties": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filters": {
      "main": [
        [
          {
            "node": "Fetch Ganttic Properties",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Proces rest api input": {
      "main": [
        [
          {
            "node": "Generate Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Query": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Output": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Ganttic Resources": {
      "main": [
        [
          {
            "node": "Process Resources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resources - INSERT": {
      "main": [
        [
          {
            "node": "More Res Pages?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Resources": {
      "main": [
        [
          {
            "node": "Get image url1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truncate Resources": {
      "main": [
        [
          {
            "node": "Set Res Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Res Page": {
      "main": [
        [
          {
            "node": "Fetch Ganttic Resources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "More Res Pages?": {
      "main": [
        [
          {
            "node": "Wait Res",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Res Page": {
      "main": [
        [
          {
            "node": "Set Res Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Res": {
      "main": [
        [
          {
            "node": "Increment Res Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sync Ganttic": {
      "main": [
        [
          {
            "node": "Truncate Resources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many users": {
      "main": [
        [
          {
            "node": "Only valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Only valid": {
      "main": [
        [
          {
            "node": "Get image links",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get image url1": {
      "main": [
        [
          {
            "node": "Resources - INSERT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get image links": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-29T11:07:48.915Z",
  "id": "oiDh643KBesTwbL7",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Resourcing Regex",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "999fafa1-c0b1-4710-a1bd-5e9279dc38ab",
              "name": "chatInput",
              "value": "={{ $json.requestData.event.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2704,
        -368
      ],
      "id": "805242f1-d807-4577-a749-bec7a19568c3",
      "name": "ChatInput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e5a7969a-49e3-47b5-a1ae-b7230bcff45c",
              "name": "seniorities",
              "value": "={{ $('Senority Regex').item.json.seniority }}",
              "type": "array"
            },
            {
              "id": "50b67ca1-499b-43b8-b50d-914652a5ce84",
              "name": "employment_types",
              "value": "={{ $('Employees Regex').item.json.employment_type }}",
              "type": "array"
            },
            {
              "id": "4ed7ef0f-4550-4fec-827d-066166a1d93d",
              "name": "industries",
              "value": "={{ $json.industries }}",
              "type": "array"
            },
            {
              "id": "2193066c-8dd2-46e9-925b-53e077beb7b7",
              "name": "roles",
              "value": "={{ $('Roles Regex').item.json.roles }}",
              "type": "array"
            },
            {
              "id": "7fac1eac-fdb8-4e67-b77b-250975a14932",
              "name": "skills",
              "value": "={{ $('Skills Regex').item.json.skills }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -176,
        -608
      ],
      "id": "3fa420d1-b00f-4498-aacb-7cd22a6e790c",
      "name": "Knobs"
    },
    {
      "parameters": {
        "jsCode": "const chatInput = $input.first().json.output.cleanInput; // This is now clean text\n\nfunction extractEmploymentType(input) {\n  const text = input.toLowerCase();\n  const types = [];\n  \n  // Check for both singular and plural\n  if (/\\b(employee|employees)\\b/.test(text)) {\n    types.push(\"Employee\");\n  }\n  \n  if (/\\b(contractor|contractors)\\b/.test(text)) {\n    types.push(\"Contractor\");\n  }\n  \n  if (/\\b(student|students)\\b/.test(text)) {\n    types.push(\"Student\");\n  }\n  \n  return types;\n}\n\nconst employment_type = extractEmploymentType(chatInput);\n\nreturn {\n  json: {\n    employment_type: employment_type\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1216,
        -608
      ],
      "id": "70604109-0e64-401b-ae8f-b140b3477954",
      "name": "Employees Regex"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.userPrompt }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.systemPrompt }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1520,
        -608
      ],
      "id": "a5793970-9193-42e8-b58a-829b597d4a47",
      "name": "Fix Typos"
    },
    {
      "parameters": {
        "jsCode": "const chatInput = $('ChatInput').first().json.chatInput;\nconst systemPrompt = \"Fix typos in this HR/staffing query. Return only corrected text.\";\n\nconst userPrompt = `Correct spelling errors in this staffing query: \"${chatInput}\"\n\nThis is about finding people for employment, so common terms are:\n\nEmployment types:\n- \"emplyee/employe/employeee\" â†’ \"employee/employees\"\n- \"contrsctor/contrctor/contracter\" â†’ \"contractor/contractors\" (freelancer, NOT constructor)\n- \"studnet/stuent/studant\" â†’ \"student/students\"\n\nSeniority levels (keep numbers!):\n- Senior, Senior 1, Senior 2\n- Mid, Mid 1, Mid 2  \n- Junior, Junior 1, Junior 2\n- Novice\n\nCommon typos to fix:\n- \"fiance/finace\" â†’ \"finance\"\n- \"bancking/bankning\" â†’ \"banking\"\n- Words with accidental punctuation: \"hand,ing\" â†’ \"handling\", \"work,ed\" â†’ \"worked\"\n- \"expeirnece/experince\" â†’ \"experience\"\n- \"knowl,edge\" â†’ \"knowledge\"\n\nRules:\n1. Keep ALL numbers exactly where they are\n2. Add spaces if missing: \"1students\" â†’ \"1 students\"\n3. Remove accidental commas/punctuation within words\n4. \"contractor\" is about employment (NOT \"constructor\")\n5. Fix only obvious typos, don't change meaning\n\nOutput only the corrected text:`;\n\nreturn {\n  json: {\n    userPrompt,\n    systemPrompt: systemPrompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1696,
        -608
      ],
      "id": "c1fc580f-78b3-4849-a750-986a09cc8433",
      "name": "Prompt - Fix Typos"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "qwen3-coder-30b-32k",
          "mode": "list",
          "cachedResultName": "qwen3-coder-30b-32k"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1520,
        -416
      ],
      "id": "bb593832-0ed8-4326-999f-b952f3ec8670",
      "name": "Qwen3 30b",
      "credentials": {
        "openAiApi": {
          "id": "09tIxrZPXx1gwPgx",
          "name": "vllm"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatInput = $('Fix Typos').first().json.output.cleanInput; // This is now clean text\n\nfunction extractSeniority(input) {\n  const text = input.toLowerCase();\n  const found = new Set();\n  \n  // Define patterns and their corresponding values\n  const patterns = [\n    // Specific levels (check these first)\n    { pattern: /\\bsenior\\s+2\\b/, values: [\"Senior 2\"] },\n    { pattern: /\\bsenior\\s+1\\b/, values: [\"Senior 1\"] },\n    { pattern: /\\bmid\\s+2\\b/, values: [\"Mid 2\"] },\n    { pattern: /\\bmid\\s+1\\b/, values: [\"Mid 1\"] },\n    { pattern: /\\bmid2\\b/, values: [\"Mid 2\"] },\n    { pattern: /\\bmid1\\b/, values: [\"Mid 1\"] },\n    { pattern: /\\bjunior\\s+2\\b/, values: [\"Junior 2\"] },\n    { pattern: /\\bjunior\\s+1\\b/, values: [\"Junior 1\"] },\n    { pattern: /\\bnovices?\\b/, values: [\"Novice\"] }  // Added s? for plural\n  ];\n  \n  // Check specific patterns first\n  let hasSpecificSenior = false;\n  let hasSpecificMid = false;\n  let hasSpecificJunior = false;\n  \n  for (const { pattern, values } of patterns) {\n    if (pattern.test(text)) {\n      values.forEach(v => found.add(v));\n      if (values[0].startsWith(\"Senior\")) hasSpecificSenior = true;\n      if (values[0].startsWith(\"Mid\")) hasSpecificMid = true;\n      if (values[0].startsWith(\"Junior\")) hasSpecificJunior = true;\n    }\n  }\n  \n  // Check generic terms only if no specific level was found\n  // Now checking for both singular and plural forms\n  if (!hasSpecificSenior && /\\b(senior|seniors)\\b/.test(text)) {\n    found.add(\"Senior 1\");\n    found.add(\"Senior 2\");\n  }\n  \n  if (!hasSpecificMid && /\\b(mid|mids)\\b/.test(text)) {\n    found.add(\"Mid 1\");\n    found.add(\"Mid 2\");\n  }\n  \n  if (!hasSpecificJunior && /\\b(junior|juniors)\\b/.test(text)) {\n    found.add(\"Junior 1\");\n    found.add(\"Junior 2\");\n  }\n  \n  // Also check for common synonyms (if they appear in clean text)\n  if (/\\b(experienced|expert|experts)\\b/.test(text) && !hasSpecificSenior) {\n    found.add(\"Senior 1\");\n    found.add(\"Senior 2\");\n  }\n  \n  if (/\\b(intermediate|intermediates)\\b/.test(text) && !hasSpecificMid) {\n    found.add(\"Mid 1\");\n    found.add(\"Mid 2\");\n  }\n  \n  if (/\\b(entry\\s+level|beginner|beginners)\\b/.test(text) && !hasSpecificJunior) {\n    found.add(\"Junior 1\");\n    found.add(\"Junior 2\");\n  }\n  \n  if (/\\b(intern|interns|trainee|trainees)\\b/.test(text)) {\n    found.add(\"Novice\");\n  }\n  \n  // Convert to array and sort\n  const order = [\"Novice\", \"Junior 1\", \"Junior 2\", \"Mid 1\", \"Mid 2\", \"Senior 1\", \"Senior 2\"];\n  return Array.from(found).sort((a, b) => order.indexOf(a) - order.indexOf(b));\n}\n\nconst seniority = extractSeniority(chatInput);\n\nreturn {\n  json: {\n    seniority: seniority\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        -608
      ],
      "id": "66e5264b-84a5-409c-8c52-961e17b95be4",
      "name": "Senority Regex"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.output }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        -608
      ],
      "id": "e262219f-aae7-450f-b8fe-0c3d1cc79936",
      "name": "Execute a SQL query",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wK2pSCG9jTniRU28",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "qwen3-coder-30b-32k",
          "mode": "list",
          "cachedResultName": "qwen3-coder-30b-32k"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -352,
        -1616
      ],
      "id": "131e1bde-5465-4f1e-a916-4c2793efc21f",
      "name": "VLLM2",
      "credentials": {
        "openAiApi": {
          "id": "09tIxrZPXx1gwPgx",
          "name": "vllm"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.sqlPrompt.userPrompt }}",
        "options": {
          "systemMessage": "=You are a helpful assistant {{ $json.sqlPrompt.systemPrompt }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        288,
        -608
      ],
      "id": "2eb1223f-6b5c-4b0a-a6ea-3d47768de84d",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "jsCode": "const generateQueryPrompt = (extractedData, originalChat) => {\n  // Pre-process: explicitly mark empty/missing values\n  const canonicalValues = {\n    role: extractedData.role && extractedData.role.length > 0 ? extractedData.role : null,\n    seniority: extractedData.seniority && extractedData.seniority.length > 0 ? extractedData.seniority : null,\n    employment_type: extractedData.employment_type && extractedData.employment_type.length > 0 ? extractedData.employment_type : null,\n    industries: extractedData.industries && extractedData.industries.length > 0 ? extractedData.industries : null,\n    skills: extractedData.skills && extractedData.skills.length > 0 ? extractedData.skills : null\n  };\n\n  const systemPrompt = `You are a PostgreSQL query generator for employee database searches.\nGenerate ONLY a single valid SQL statement (end with a semicolon). No prose, no explanations.\n\nDATABASE: ganttic_api_resources\n\nCOLUMNS:\n- id (text)\n- name (text)\n- role (text)\n- seniority (text)\n- employment_type (text)\n- industries (text[])\n- skills_senior (text[])\n- skills_medium (text[])\n- skills_junior (text[])\n- description (text)\n- certs (text[])\n\nCRITICAL RULE - READ CAREFULLY:\nYou must ONLY use values from CANONICAL_VALUES below. \nIf a field is null in CANONICAL_VALUES, you MUST NOT include it in the WHERE clause.\nDO NOT infer, guess, or extract values from the natural language request.\nThe natural language is ONLY for understanding query intent (COUNT vs SELECT, AND vs OR logic).\nNEVER add a filter for a field that is null in CANONICAL_VALUES.\n\nExamples of what NOT to do:\n- Natural request mentions \"developer\" but role is null â†’ DO NOT add role = 'Developer' or any role filter\n- Natural request mentions \"senior\" but seniority is null â†’ DO NOT add seniority filter\n- Natural request mentions \"banking\" but industries is null â†’ DO NOT add industries filter`;\n\n  // Build explicit instructions based on what's actually present\n  let filterInstructions = '\\nFILTERS TO APPLY (only these, nothing else):';\n  let hasAnyFilter = false;\n\n  if (canonicalValues.role) {\n    filterInstructions += `\\n- role: Use role = '${canonicalValues.role}'`;\n    hasAnyFilter = true;\n  } else {\n    filterInstructions += `\\n- role: NULL - DO NOT FILTER BY ROLE`;\n  }\n\n  if (canonicalValues.seniority) {\n    filterInstructions += `\\n- seniority: Use seniority = '${canonicalValues.seniority}'`;\n    hasAnyFilter = true;\n  } else {\n    filterInstructions += `\\n- seniority: NULL - DO NOT FILTER BY SENIORITY`;\n  }\n\n  if (canonicalValues.employment_type) {\n    filterInstructions += `\\n- employment_type: Use employment_type = '${canonicalValues.employment_type}'`;\n    hasAnyFilter = true;\n  } else {\n    filterInstructions += `\\n- employment_type: NULL - DO NOT FILTER BY EMPLOYMENT TYPE`;\n  }\n\n  if (canonicalValues.industries && canonicalValues.industries.length > 0) {\n    const industryList = canonicalValues.industries.map(i => `'${i}'`).join(', ');\n    filterInstructions += `\\n- industries: Use (${canonicalValues.industries.map(i => `'${i}' = ANY(industries)`).join(' OR ')})`;\n    hasAnyFilter = true;\n  } else {\n    filterInstructions += `\\n- industries: NULL - DO NOT FILTER BY INDUSTRIES`;\n  }\n\n  if (canonicalValues.skills && canonicalValues.skills.length > 0) {\n    filterInstructions += `\\n- skills: For each skill, check all three arrays with OR. Skills to filter: ${canonicalValues.skills.join(', ')}`;\n    hasAnyFilter = true;\n  } else {\n    filterInstructions += `\\n- skills: NULL - DO NOT FILTER BY SKILLS`;\n  }\n\n  if (!hasAnyFilter) {\n    filterInstructions += `\\n\\nNO FILTERS PROVIDED - Return all records with LIMIT 100`;\n  }\n\n  const userPrompt = `NATURAL REQUEST (for intent only, NOT for extracting filter values): \"${originalChat}\"\n\nCANONICAL_VALUES (the ONLY source of truth for WHERE clause values):\n${JSON.stringify(canonicalValues, null, 2)}\n${filterInstructions}\n\nQUERY TYPE (determine from natural language):\n- \"how many\" / \"count\" / \"number of\" â†’ SELECT COUNT(*)\n- \"list\" / \"show\" / \"who\" / \"find\" â†’ SELECT name, role, seniority, employment_type, industries, skills_senior, skills_medium, skills_junior, description, certs\n- \"all\" / \"everyone\" â†’ SELECT * with LIMIT 30\n- \"best\" / \"top\" â†’ SELECT * ORDER BY seniority weight DESC, LIMIT 10\n- \"breakdown\" / \"by role\" / \"by seniority\" â†’ GROUP BY with COUNT(*)\n\nSKILLS ARRAY LOGIC (only if skills is not null):\nFor each skill S: ('S' = ANY(skills_senior) OR 'S' = ANY(skills_medium) OR 'S' = ANY(skills_junior))\nMultiple skills: combine with AND\n\nDEFAULT: Add LIMIT 20 for list queries.\n\nGenerate the SQL query now:`;\n\n  return { systemPrompt, userPrompt };\n};\n\n// Usage example\nconst sqlPrompt = generateQueryPrompt(\n  {\n    role: $input.first().json.roles,\n    seniority: $input.first().json.seniorities,\n    employment_type: $input.first().json.employment_types,\n    industries: $input.first().json.industries,\n    skills: $input.first().json.skills\n  },\n  $('ChatInput').first().json.chatInput\n);\n\nreturn {\n  json: {\n    sqlPrompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        -608
      ],
      "id": "e027c44f-5b60-4153-8256-b84a5130f35e",
      "name": "Generate SQL Query"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n    \"cleanInput\": \"fixed query\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1376,
        -416
      ],
      "id": "2e7d029c-5c00-4be9-94a9-60bb4690c3d1",
      "name": "JSON"
    },
    {
      "parameters": {
        "jsCode": "// Get the typo-corrected input\nconst cleanInput = $('Fix Typos').first().json.output.cleanInput.toLowerCase();\n\n// Generic person/worker terms that users might use instead of \"developer/engineer\"\n// These MUST appear directly after the technology to qualify as a role\nconst personTerms = `(?:developers?|engineers?|devs?|engs?|employees?|contractors?|persons?|guys?|people|resources?|specialists?|experts?|professionals?|workers?|talents?|candidates?|members?|folks?|staff|hires?|consultants?)`;\n\n// Role patterns - STRICT: technology must be followed directly by person term\n// This ensures \"react employee\" = role, but \"knows angular\" = skill (handled elsewhere)\nconst rolePatterns = {\n  // Backend Engineers - technology + person term (strict adjacency)\n  'Node.js Engineer': new RegExp(`\\\\bnode(?:\\\\.?js)?[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'Python Engineer': new RegExp(`\\\\bpython[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'Java Engineer': new RegExp(`\\\\bjava(?!script)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'PHP Engineer': new RegExp(`\\\\bphp[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'Ruby Engineer': new RegExp(`\\\\bruby[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  '.NET Engineer': new RegExp(`\\\\b(?:\\\\.net|dotnet|dot[\\\\s-]*net|c#|csharp)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  \n  // Frontend Engineers\n  'React Engineer': new RegExp(`\\\\breact(?:\\\\.?js)?(?![\\\\s-]*native)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'Angular Engineer': new RegExp(`\\\\bangular(?:\\\\.?js)?[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'Vue.js Engineer': new RegExp(`\\\\bvue(?:\\\\.?js)?[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  \n  // Specialized Engineers\n  'Mobile Engineer': new RegExp(`\\\\b(?:mobile|ios|android|flutter|react[\\\\s-]*native|swift|kotlin)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'WordPress Engineer': new RegExp(`\\\\b(?:wordpress|wp)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'DevOps Engineer': new RegExp(`\\\\b(?:devops|dev[\\\\s-]*ops|sre|site[\\\\s-]*reliability|infrastructure|infra|kubernetes|k8s|docker|aws|azure|gcp|cloud)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'QA Engineer': new RegExp(`\\\\b(?:qa|quality[\\\\s-]*assurance|test(?:ing)?|testers?|automation[\\\\s-]*test(?:ing)?)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'AI Engineer': new RegExp(`\\\\b(?:ai|artificial[\\\\s-]*intelligence|ml|machine[\\\\s-]*learning|deep[\\\\s-]*learning|nlp|computer[\\\\s-]*vision)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  'Data Engineer': /\\bdata[\\s-]*(?:engineers?|engs?|developers?|devs?)\\b/i,\n  'Technical Support Engineer': new RegExp(`\\\\b(?:technical[\\\\s-]*support|support|helpdesk|help[\\\\s-]*desk)[\\\\s-]*${personTerms}\\\\b`, 'i'),\n  \n  // Data & Analysis\n  'Data Expert': /\\bdata[\\s-]*(?:scientists?|analysts?|specialists?|experts?)\\b/i,\n  'Business Analyst': /\\b(?:business[\\s-]*analysts?|business[\\s-]*analysis)\\b/i,\n  \n  // Design - designer is the person term itself\n  'UI/UX Designer': /\\b(?:ui|ux|user[\\s-]*interface|user[\\s-]*experience|product|ui\\/ux|ux\\/ui|web|graphic|visual)[\\s-]*designers?\\b/i,\n  \n  // Management & Leadership - these have person term built into role name\n  'Project Manager': /\\b(?:project[\\s-]*managers?|scrum[\\s-]*masters?|agile[\\s-]*coach(?:es)?)\\b/i,\n  'Product owner': /\\b(?:product[\\s-]*owners?|product[\\s-]*managers?)\\b/i,\n  'Program manager': /\\bprogram[\\s-]*managers?\\b/i,\n  'Engineering Lead': /\\b(?:engineering[\\s-]*leads?|tech[\\s-]*leads?|technical[\\s-]*leads?|team[\\s-]*leads?|lead[\\s-]*engineers?)\\b/i,\n  'Solution Architect': /\\b(?:solutions?[\\s-]*architects?|enterprise[\\s-]*architects?)\\b/i,\n  \n  // Excellence Managers\n  'Manager of Frontend Excellence': /\\b(?:managers?[\\s-]*of[\\s-]*frontend[\\s-]*excellence|frontend[\\s-]*excellence[\\s-]*managers?|frontend[\\s-]*managers?)\\b/i,\n  'Manager of Design Excellence': /\\b(?:managers?[\\s-]*of[\\s-]*design[\\s-]*excellence|design[\\s-]*excellence[\\s-]*managers?|design[\\s-]*managers?)\\b/i,\n  'Manager of Project Management Excellence': /\\b(?:managers?[\\s-]*of[\\s-]*project[\\s-]*management[\\s-]*excellence|pm[\\s-]*excellence|pmo[\\s-]*managers?)\\b/i,\n  'Manager of BA Excellence': /\\b(?:managers?[\\s-]*of[\\s-]*ba[\\s-]*excellence|ba[\\s-]*excellence[\\s-]*managers?|ba[\\s-]*managers?)\\b/i,\n  'Centre of Excellence Head of Technology': /\\b(?:centre[\\s-]*of[\\s-]*excellence[\\s-]*heads?|heads?[\\s-]*of[\\s-]*technology|technology[\\s-]*directors?)\\b/i,\n};\n\n// Generic role patterns (backend/frontend/fullstack + person term)\nconst genericBackendPattern = new RegExp(`\\\\bback[\\\\s-]*ends?[\\\\s-]*${personTerms}\\\\b`, 'i');\nconst genericFrontendPattern = new RegExp(`\\\\bfront[\\\\s-]*ends?[\\\\s-]*${personTerms}\\\\b`, 'i');\nconst genericFullStackPattern = new RegExp(`\\\\bfull[\\\\s-]*stacks?[\\\\s-]*${personTerms}\\\\b`, 'i');\n\n// Standalone generic terms (just \"backend\", \"frontend\" without tech or person term)\n// Only match if followed by person term OR if it's clearly the subject\nconst standaloneBackendWithPerson = new RegExp(`\\\\bback[\\\\s-]*ends?[\\\\s-]*${personTerms}\\\\b`, 'i');\nconst standaloneFrontendWithPerson = new RegExp(`\\\\bfront[\\\\s-]*ends?[\\\\s-]*${personTerms}\\\\b`, 'i');\nconst standaloneFullStackWithPerson = new RegExp(`\\\\bfull[\\\\s-]*stacks?[\\\\s-]*${personTerms}\\\\b`, 'i');\n\n// Generic \"developer\" or \"engineer\" without specific technology\n// e.g., \"find me a senior developer\" or \"show developers\"\nconst genericDeveloperPattern = new RegExp(`(?:^|\\\\s)(?:senior|mid|junior|lead)?[\\\\s-]*${personTerms}(?:\\\\s|$|\\\\.|,)`, 'i');\n\n// Extract roles\nconst extractedRoles = new Set();\n\n// Check each role pattern\nfor (const [roleName, pattern] of Object.entries(rolePatterns)) {\n  if (pattern.test(cleanInput)) {\n    extractedRoles.add(roleName);\n  }\n}\n\n// Handle generic backend/frontend/fullstack terms\nconst hasSpecificBackend = ['Node.js Engineer', 'Python Engineer', 'Java Engineer', 'PHP Engineer', 'Ruby Engineer', '.NET Engineer']\n  .some(role => extractedRoles.has(role));\n\nconst hasSpecificFrontend = ['React Engineer', 'Angular Engineer', 'Vue.js Engineer']\n  .some(role => extractedRoles.has(role));\n\nif ((genericBackendPattern.test(cleanInput) || standaloneBackendWithPerson.test(cleanInput)) && !hasSpecificBackend) {\n  extractedRoles.add('Node.js Engineer');\n  extractedRoles.add('Python Engineer');\n  extractedRoles.add('Java Engineer');\n  extractedRoles.add('PHP Engineer');\n  extractedRoles.add('.NET Engineer');\n}\n\nif ((genericFrontendPattern.test(cleanInput) || standaloneFrontendWithPerson.test(cleanInput)) && !hasSpecificFrontend) {\n  extractedRoles.add('React Engineer');\n  extractedRoles.add('Angular Engineer');\n  extractedRoles.add('Vue.js Engineer');\n}\n\nif (genericFullStackPattern.test(cleanInput) || standaloneFullStackWithPerson.test(cleanInput)) {\n  extractedRoles.add('React Engineer');\n  extractedRoles.add('Node.js Engineer');\n  extractedRoles.add('Python Engineer');\n}\n\n// Return as array (empty array if no roles found - skills will be extracted separately)\nreturn {\n  json: {\n    roles: Array.from(extractedRoles)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -832,
        -608
      ],
      "id": "dae89773-8269-4525-995c-47446d6cfe19",
      "name": "Roles Regex"
    },
    {
      "parameters": {
        "jsCode": "// Get the typo-corrected input\nconst cleanInput = $('Fix Typos').first().json.output.cleanInput.toLowerCase();\n\n// Get extracted roles to avoid duplicating base technologies\nconst extractedRoles = $input.first().json.roles || [];\n\n// Map roles to their base technology keywords (to exclude from skill matching)\nconst roleBaseTechnologies = {\n  'Python Engineer': ['python'],\n  'Node.js Engineer': ['node', 'nodejs', 'node.js'],\n  'Java Engineer': ['java'],\n  'PHP Engineer': ['php'],\n  'Ruby Engineer': ['ruby'],\n  '.NET Engineer': ['c#', 'csharp', '.net', 'dotnet'],\n  'React Engineer': ['react', 'reactjs'],\n  'Angular Engineer': ['angular', 'angularjs'],\n  'Vue.js Engineer': ['vue', 'vuejs'],\n  'Mobile Engineer': ['mobile'],\n  'DevOps Engineer': ['devops'],\n  'QA Engineer': ['qa', 'testing'],\n  'AI Engineer': ['ai', 'ml', 'artificial intelligence', 'machine learning'],\n  'WordPress Engineer': ['wordpress', 'wp'],\n  'UI/UX Designer': ['design'],\n};\n\n// Get base techs from extracted roles (to exclude from skill extraction)\nconst excludedBaseTechs = new Set();\nfor (const role of extractedRoles) {\n  const baseTechs = roleBaseTechnologies[role] || [];\n  baseTechs.forEach(tech => excludedBaseTechs.add(tech));\n}\n\n// Skill patterns - ONLY specific frameworks/tools, NOT base technologies\n// Base technologies are handled by role extraction\nconst skillPatterns = {\n  // Python frameworks - specific only\n  'Python - Django': /\\bdjango\\b/i,\n  'Python - Flask': /\\bflask\\b/i,\n  'Python - FastAPI': /\\bfastapi\\b/i,\n  'Python - DS/DE': /\\b(?:pandas|numpy|jupyter|scipy|matplotlib)\\b/i,\n  \n  // Node.js frameworks - specific only\n  'Node.js - Express': /\\bexpress(?:\\.?js)?\\b/i,\n  'Node.js - Nest.js': /\\bnest(?:\\.?js)?\\b/i,\n  'Node.js - Koa.js': /\\bkoa(?:\\.?js)?\\b/i,\n  'Node.js - Meteor': /\\bmeteor(?:\\.?js)?\\b/i,\n  \n  // PHP frameworks - specific only\n  'PHP - Laravel': /\\blaravel\\b/i,\n  'PHP - Symfony': /\\bsymfony\\b/i,\n  \n  // Ruby frameworks - specific only\n  'Ruby - Rails': /\\b(?:rails|ruby on rails|ror)\\b/i,\n  'Ruby - Sinatra': /\\bsinatra\\b/i,\n  \n  // Java frameworks - specific only\n  'Java - Spring (Boot)': /\\bspring(?:\\s*boot)?\\b/i,\n  'Java - J2EE': /\\bj2ee\\b/i,\n  'Java - Hibernate': /\\bhibernate\\b/i,\n  \n  // Kotlin frameworks - specific only\n  'Kotlin - Ktor': /\\bktor\\b/i,\n  'Kotlin - Micronaut': /\\bmicronaut\\b/i,\n  \n  // Go frameworks - specific only\n  'GO - beego': /\\bbeego\\b/i,\n  'GO - gin': /\\bgin\\b/i,\n  \n  // .NET frameworks - specific only\n  'C# - .NET Core': /\\b(?:\\.net\\s*core|dotnet\\s*core)\\b/i,\n  'C# - .NET Framework': /\\b\\.net\\s*framework\\b/i,\n  'C# - Unity': /\\bunity(?:3d)?\\b/i,\n  'C# - Blazor': /\\bblazor\\b/i,\n  \n  // Frontend frameworks - specific only\n  'JS - React': /\\breact(?:\\.?js)?(?!\\s*native)\\b/i,\n  'JS - Next.js': /\\bnext(?:\\.?js)?\\b/i,\n  'JS - Angular': /\\bangular(?:\\.?js)?\\b/i,\n  'JS - Vue.js': /\\bvue(?:\\.?js)?\\b/i,\n  'JS - Nuxt.js': /\\bnuxt(?:\\.?js)?\\b/i,\n  'JS - Svelte': /\\bsvelte\\b/i,\n  'JS - TypeScript': /\\btypescript\\b/i,\n  'JS - Redux': /\\bredux\\b/i,\n  'Web Slice/CSS/HTML': /\\b(?:html5?|css3?|sass|scss|less|tailwind|bootstrap)\\b/i,\n  \n  // CMS Platforms - specific only\n  'CMS - Wordpress': /\\b(?:wordpress|wp)\\b/i,\n  'CMS - Drupal': /\\bdrupal\\b/i,\n  'CMS - Strapi': /\\bstrapi\\b/i,\n  'CMS - CraftCMS': /\\b(?:craftcms|craft\\s*cms)\\b/i,\n  'CMS - Contentful': /\\bcontentful\\b/i,\n  \n  // E-commerce - specific only\n  'Magento - e-comm': /\\bmagento\\b/i,\n  'Shopify - e-comm': /\\bshopify\\b/i,\n  'WooCommerce - e-comm': /\\bwoocommerce\\b/i,\n  'Sylius - e-comm': /\\bsylius\\b/i,\n  \n  // Mobile - specific only\n  'Android': /\\bandroid\\b/i,\n  'iOS': /\\b(?:ios|swift|objective-c|objc)\\b/i,\n  'Flutter': /\\bflutter\\b/i,\n  'ReactNative': /\\breact\\s*native\\b/i,\n  'Kotlin Mobile': /\\bkotlin\\b/i,\n  \n  // DevOps & Cloud - specific only\n  'DevOps - AWS': /\\b(?:aws|amazon\\s*web\\s*services|ec2|s3|lambda|dynamodb)\\b/i,\n  'DevOps - Azure': /\\b(?:azure|microsoft\\s*azure)\\b/i,\n  'DevOps - GCP': /\\b(?:gcp|google\\s*cloud)\\b/i,\n  'DevOps - Kubernetes': /\\b(?:kubernetes|k8s)\\b/i,\n  'DevOps - Docker': /\\bdocker\\b/i,\n  'DevOps - Terraform': /\\bterraform\\b/i,\n  'DevOps - Ansible': /\\bansible\\b/i,\n  'DevOps - CI/CD': /\\b(?:ci\\/cd|cicd|jenkins|github\\s*actions|gitlab\\s*ci|circleci)\\b/i,\n  'DevOps - Linux/Unix': /\\b(?:linux|unix|bash|shell)\\b/i,\n  \n  // AI & ML - specific only\n  'AI - TensorFlow': /\\btensorflow\\b/i,\n  'AI - PyTorch': /\\bpytorch\\b/i,\n  'AI - Keras': /\\bkeras\\b/i,\n  'AI - scikit-learn': /\\b(?:scikit-learn|sklearn)\\b/i,\n  'AI - LLM': /\\b(?:llm|large\\s*language\\s*model|gpt|openai|anthropic|claude|llama)\\b/i,\n  'AI - RAG': /\\b(?:rag|retrieval\\s*augmented|vector\\s*database|pinecone|weaviate|chromadb)\\b/i,\n  'AI - Prompt Engineering': /\\b(?:prompt\\s*engineering|prompting)\\b/i,\n  'AI - Computer Vision': /\\b(?:computer\\s*vision|opencv|yolo|image\\s*recognition)\\b/i,\n  'AI - NLP': /\\b(?:nlp|natural\\s*language\\s*processing|spacy|nltk|hugging\\s*face)\\b/i,\n  'AI - MLOps': /\\b(?:mlops|llmops|kubeflow|mlflow)\\b/i,\n  'AI - Agents': /\\b(?:ai\\s*agents?|agentic|langchain|langgraph|autogen)\\b/i,\n  'AI - N8N': /\\bn8n\\b/i,\n  \n  // QA - specific only\n  'QA - Selenium': /\\bselenium\\b/i,\n  'QA - Cypress': /\\bcypress\\b/i,\n  'QA - Playwright': /\\bplaywright\\b/i,\n  'QA - Jest': /\\bjest\\b/i,\n  'QA - JUnit': /\\bjunit\\b/i,\n  'QA - Manual testing': /\\bmanual\\s*testing\\b/i,\n  'QA - Performance testing': /\\b(?:performance\\s*testing|load\\s*testing|jmeter|gatling)\\b/i,\n  \n  // Design - specific only\n  'Design - Figma': /\\bfigma\\b/i,\n  'Design - Sketch': /\\bsketch\\b/i,\n  'Design - Adobe XD': /\\b(?:adobe\\s*xd|xd)\\b/i,\n  'Design - InVision': /\\binvision\\b/i,\n  'Design - UX Research': /\\b(?:ux\\s*research|user\\s*research|usability)\\b/i,\n  \n  // Databases\n  'Database - PostgreSQL': /\\b(?:postgresql|postgres)\\b/i,\n  'Database - MySQL': /\\bmysql\\b/i,\n  'Database - MongoDB': /\\b(?:mongodb|mongo)\\b/i,\n  'Database - Redis': /\\bredis\\b/i,\n  'Database - Elasticsearch': /\\b(?:elasticsearch|elastic)\\b/i,\n  'Database - SQL Server': /\\b(?:sql\\s*server|mssql)\\b/i,\n  'Database - Oracle': /\\boracle\\b/i,\n  'Database - DynamoDB': /\\bdynamodb\\b/i,\n  \n  // Other specific skills\n  'GraphQL': /\\bgraphql\\b/i,\n  'REST API': /\\b(?:rest\\s*api|restful)\\b/i,\n  'Microservices': /\\bmicroservices?\\b/i,\n  'RabbitMQ': /\\brabbitmq\\b/i,\n  'Kafka': /\\bkafka\\b/i,\n  'WebSockets': /\\bwebsockets?\\b/i,\n  'gRPC': /\\bgrpc\\b/i,\n  'SEO': /\\b(?:seo|search\\s*engine\\s*optimization)\\b/i,\n  'Blockchain': /\\b(?:blockchain|solidity|ethereum|smart\\s*contract|web3)\\b/i,\n};\n\n// Context patterns that indicate a skill mention\nconst skillContextPatterns = {\n  before: [\n    /(?:knows?)\\s+$/i,\n    /(?:know)\\s+$/i,\n    /(?:knowing)\\s+$/i,\n    /(?:with)\\s+$/i,\n    /(?:using)\\s+$/i,\n    /(?:experienced?\\s+(?:in|with))\\s+$/i,\n    /(?:skilled?\\s+(?:in|with))\\s+$/i,\n    /(?:worked\\s+with)\\s+$/i,\n    /(?:working\\s+with)\\s+$/i,\n    /(?:familiar\\s+with)\\s+$/i,\n    /(?:background\\s+in)\\s+$/i,\n    /(?:proficient\\s+in)\\s+$/i,\n    /(?:expertise\\s+in)\\s+$/i,\n    /(?:expert\\s+in)\\s+$/i,\n    /(?:knowledge\\s+(?:of|in))\\s+$/i,\n    /(?:understanding\\s+of)\\s+$/i,\n    // Multiple skills support - require word boundary before and/or\n    /\\s+and\\s+$/i,\n    /\\s+or\\s+$/i,\n    /,\\s*$/i,\n    /&\\s*$/i,\n  ],\n  after: [\n    /^\\s*(?:experience|background|expertise|knowledge)/i,\n    /^\\s*(?:skills?)/i,\n    // Multiple skills support\n    /^\\s+and\\s+/i,\n    /^\\s+or\\s+/i,\n    /^\\s*,/i,\n    /^\\s*&/i,\n  ]\n};\n\n// Function to check if skill keyword has valid context\nconst hasValidSkillContext = (input, keywordStart, keywordEnd) => {\n  const textBefore = input.substring(Math.max(0, keywordStart - 50), keywordStart);\n  const textAfter = input.substring(keywordEnd, Math.min(input.length, keywordEnd + 30));\n  \n  for (const pattern of skillContextPatterns.before) {\n    if (pattern.test(textBefore)) return true;\n  }\n  for (const pattern of skillContextPatterns.after) {\n    if (pattern.test(textAfter)) return true;\n  }\n  return false;\n};\n\n// Extract skills\nconst extractedSkills = new Set();\n\n// Sort by pattern length (longer patterns first to match \"react native\" before \"react\")\nconst sortedSkills = Object.entries(skillPatterns).sort((a, b) => {\n  return b[1].source.length - a[1].source.length;\n});\n\n// Track matched positions to avoid double-matching\nconst matchedPositions = new Set();\n\nfor (const [skillName, pattern] of sortedSkills) {\n  const globalPattern = new RegExp(pattern.source, 'gi');\n  let match;\n  \n  while ((match = globalPattern.exec(cleanInput)) !== null) {\n    const keywordStart = match.index;\n    const keywordEnd = match.index + match[0].length;\n    \n    // Check if already matched by a longer pattern\n    let alreadyMatched = false;\n    for (let pos = keywordStart; pos < keywordEnd; pos++) {\n      if (matchedPositions.has(pos)) {\n        alreadyMatched = true;\n        break;\n      }\n    }\n    if (alreadyMatched) continue;\n    \n    // Check if this skill has valid context\n    if (hasValidSkillContext(cleanInput, keywordStart, keywordEnd)) {\n      // Mark positions as matched\n      for (let pos = keywordStart; pos < keywordEnd; pos++) {\n        matchedPositions.add(pos);\n      }\n      extractedSkills.add(skillName);\n    }\n  }\n}\n\n// Return as array\nreturn {\n  json: {\n    skills: Array.from(extractedSkills)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        -608
      ],
      "id": "4acd357a-50f2-4c24-8c54-c9e52f32afeb",
      "name": "Skills Regex"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        288,
        -416
      ],
      "id": "b0aec318-f385-4a0a-be88-538c6d410a4f",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "405i02YoCznHTji7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n    \"response_type\": \"count | list | search | comparison | breakdown | no_results\",\n    \"summary\": \"One-line answer to the user's question\",\n    \"total_found\": 0,\n    \"main_response\": \"The conversational response text with names, details, and insights\",\n    \"highlights\": [\n      {\n        \"name\": \"Person name\",\n        \"role\": \"Their role\",\n        \"seniority\": \"Their seniority level\",\n        \"employment_type\": \"Employee/Contractor\",\n        \"key_skills\": [\"skill1\", \"skill2\"],\n        \"industries\": [\"industry1\", \"industry2\"],\n        \"match_reason\": \"Why this person is relevant (optional, use for search queries)\"\n      }\n    ],\n    \"insights\": [\"Any patterns or observations worth noting\"],\n    \"suggestions\": [\"Alternative searches or recommendations if applicable\"]\n  }"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -112,
        -1584
      ],
      "id": "f383359d-3c10-4e82-beb3-9cc9fb3e4d8a",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "jsCode": "const generateSlackMarkdownPrompt = (jsonResponse) => {\n  \n  const systemPrompt = `You are a formatting assistant that converts structured JSON data into Slack-compatible mrkdwn format.\n\nSLACK MRKDWN RULES (different from standard markdown):\n- Bold: *text* (single asterisk, NOT double)\n- Italic: _text_ (underscore)\n- Strikethrough: ~text~\n- Code: \\`text\\`\n- Code block: \\`\\`\\`text\\`\\`\\`\n- Links: <url|text>\n- Line breaks: Just use newlines\n- Lists: Use â€¢ or - with spaces\n- NO ## headers (Slack doesn't support them)\n- NO **double asterisks** for bold\n\nOUTPUT RULES:\n1. Output ONLY Slack mrkdwn - no JSON, no wrapping\n2. Be concise - busy people should get the answer in 2 seconds\n3. Use emoji for visual hierarchy\n4. Never mention JSON or technical details\n5. Keep it scannable and clean`;\n\n  const userPrompt = `Convert this JSON to Slack mrkdwn format:\n\n${JSON.stringify(jsonResponse, null, 2)}\n\nFORMAT BASED ON RESPONSE TYPE:\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF response_type = \"count\":\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\n[If insights exist, add as brief note with ğŸ’¡]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF response_type = \"list\" or \"search\":\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\n[For each person in highlights:]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ *[name]* â€” [role], [seniority]\n     ğŸ“Œ [employment_type]\n     ğŸ› ï¸ [key_skills as comma-separated]\n     ğŸ¢ [industries as comma-separated]\n     [If match_reason exists:] âœ¨ _[match_reason]_\n\n[If insights exist:]\nğŸ’¡ *Insights:* [insights as comma-separated]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF response_type = \"comparison\":\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\nğŸ† *Top Matches:*\n\n[For each person in highlights, numbered:]\n*[rank]. [name]* â€” [role], [seniority]\n     ğŸ“Œ [employment_type] | ğŸ› ï¸ [key_skills]\n     ğŸ¢ [industries]\n     [If match_reason:] âœ¨ _[match_reason]_\n\n[insights if present]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF response_type = \"breakdown\":\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\nğŸ“Š *Breakdown:*\n[Format as simple list with bullets â€¢]\n\n[insights if present]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF response_type = \"no_results\":\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]* ğŸ˜•\n\n[main_response]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSLACK FORMATTING REMINDERS:\nâ€¢ Bold = *single asterisks* NOT **double**\nâ€¢ Use â€” (em dash) instead of - for separators in text\nâ€¢ Use â€¢ for bullet points\nâ€¢ Use â”â”â” line for visual separation between people\nâ€¢ Indent with spaces (5 spaces) for sub-info under names\nâ€¢ Keep lines short - Slack wraps awkwardly on long lines\nâ€¢ Max 5 people in highlights, mention if more exist\nâ€¢ No headers - use *bold* with emoji instead\n\nOUTPUT THE SLACK MRKDWN NOW:`;\n\n  return {\n    systemPrompt,\n    userPrompt\n  };\n};\n\n// Usage in n8n\nconst jsonResponse = $input.first().json;\n\n// Handle case where response might be nested or stringified\nlet parsedResponse = jsonResponse;\nif (typeof jsonResponse === 'string') {\n  try {\n    parsedResponse = JSON.parse(jsonResponse);\n  } catch (e) {\n    parsedResponse = jsonResponse;\n  }\n}\n\n// If the response is nested under a key like 'output' or 'response'\nif (parsedResponse.output) {\n  parsedResponse = parsedResponse.output;\n}\n\nconst markdownPrompt = generateSlackMarkdownPrompt(parsedResponse);\n\nreturn {\n  json: {\n    markdownPrompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -1792
      ],
      "id": "59d57c2f-ec32-46c6-8508-c46e290084e2",
      "name": "JSON to Markdown"
    },
    {
      "parameters": {
        "jsCode": "const generateResponsePrompt = (queryResults, originalChat, sqlExecuted) => {\n  \n  const systemPrompt = `You are a helpful HR assistant presenting database query results conversationally.\nBe natural, specific, and helpful. Focus on answering what the user actually asked.\n\nRESPONSE RULES:\n1. Be conversational but professional\n2. Use actual names and numbers from the data\n3. Don't just dump data - interpret and summarize\n4. Highlight important patterns or insights\n5. Keep responses concise but complete\n6. If no results, suggest alternatives\n7. Never mention SQL, databases, or technical details\n\nOUTPUT FORMAT:\nYou must respond with a valid JSON object matching the structure provided. Do not include any text outside the JSON.\nDo not wrap in markdown code blocks. Output raw JSON only.`;\n\n  const outputSchema = {\n    \"response_type\": \"count | list | search | comparison | breakdown | no_results\",\n    \"summary\": \"One-line answer to the user's question\",\n    \"total_found\": 0,\n    \"main_response\": \"The conversational response text with names, details, and insights\",\n    \"highlights\": [\n      {\n        \"name\": \"Person name\",\n        \"role\": \"Their role\",\n        \"seniority\": \"Their seniority level\",\n        \"employment_type\": \"Employee/Contractor\",\n        \"key_skills\": [\"skill1\", \"skill2\"],\n        \"industries\": [\"industry1\", \"industry2\"],\n        \"match_reason\": \"Why this person is relevant (optional, use for search queries)\"\n      }\n    ],\n    \"insights\": [\"Any patterns or observations worth noting\"],\n    \"suggestions\": [\"Alternative searches or recommendations if applicable\"]\n  };\n\n  const userPrompt = `USER ASKED: \"${originalChat}\"\n\nQUERY RESULTS (${queryResults.length} records):\n${JSON.stringify(queryResults.slice(0, 15), null, 2)}\n${queryResults.length > 15 ? `... and ${queryResults.length - 15} more results` : ''}\n\nRESPOND WITH THIS EXACT JSON STRUCTURE:\n${JSON.stringify(outputSchema, null, 2)}\n\nFIELD GUIDELINES:\n\nresponse_type - Choose exactly one:\n- \"count\" â†’ for \"how many\" questions\n- \"list\" â†’ for \"show me\", \"list\", \"who\" questions  \n- \"search\" â†’ for \"find\", \"need\", \"looking for\" questions\n- \"comparison\" â†’ for \"best\", \"top\", \"compare\" questions\n- \"breakdown\" â†’ for analysis/distribution questions\n- \"no_results\" â†’ when no matches found\n\nsummary - Single sentence answering the core question directly\n\ntotal_found - The actual number from results\n\nmain_response - Conversational answer (2-4 sentences) with specific names and context\n\nhighlights - Array of top 1-5 most relevant people (empty [] for count-only questions)\n- Include all fields available in the query results\n- Add match_reason only for search/comparison queries\n\ninsights - Array of 0-3 observations (empty [] if none)\n\nsuggestions - Array of 0-2 recommendations (empty [] if none)\n\nCRITICAL: Output ONLY valid JSON. No markdown, no explanation, no code blocks.`;\n\n  return {\n    systemPrompt,\n    userPrompt\n  };\n};\n\n// Usage example\nconst sqlPrompt = generateResponsePrompt(\n  $input.all().map(item => item.json),\n  $('ChatInput').first().json.chatInput, \n  $('AI Agent1').first().json.output\n);\n\nreturn {\n  json: {\n    sqlPrompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        -1792
      ],
      "id": "cf2671ab-c0e1-4ca1-840d-80f018d587d2",
      "name": "Prompt for Reponse"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.sqlPrompt.userPrompt }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "="
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -288,
        -1792
      ],
      "id": "d4e622dc-d41e-4c1d-b254-49c4ec25ed4f",
      "name": "Response in JSON"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.slackPrompt.userPrompt }}",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.slackPrompt.systemPrompt }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1120,
        -608
      ],
      "id": "db73d04f-6b76-4928-9592-89e2d841634f",
      "name": "Response in Markdown"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "qwen3-coder-30b-32k",
          "mode": "list",
          "cachedResultName": "qwen3-coder-30b-32k"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1104,
        -240
      ],
      "id": "89e8748d-52d1-4061-89b2-2a003e2d221e",
      "name": "VLLM",
      "credentials": {
        "openAiApi": {
          "id": "09tIxrZPXx1gwPgx",
          "name": "vllm"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the typo-corrected input\nconst cleanInput = $('Fix Typos').first().json.output.cleanInput.toLowerCase();\n\n// Comprehensive industry keywords mapped to canonical names\nconst industryKeywords = {\n  // Finance cluster\n  'fintech': ['Fintech', 'Banking & Insurance'],\n  'financial technology': ['Fintech', 'Banking & Insurance'],\n  'financial tech': ['Fintech', 'Banking & Insurance'],\n  'banking': ['Banking & Insurance'],\n  'bank': ['Banking & Insurance'],\n  'banks': ['Banking & Insurance'],\n  'insurance': ['Banking & Insurance'],\n  'financial services': ['Banking & Insurance'],\n  'financial service': ['Banking & Insurance'],\n  'finance': ['Banking & Insurance'],\n  'finance industry': ['Banking & Insurance'],\n  'finance sector': ['Banking & Insurance'],\n  'financial sector': ['Banking & Insurance'],\n  'financial industry': ['Banking & Insurance'],\n  'financial': ['Banking & Insurance'],\n  'investment': ['Banking & Insurance'],\n  'investments': ['Banking & Insurance'],\n  'wealth management': ['Banking & Insurance'],\n  'asset management': ['Banking & Insurance'],\n  'capital markets': ['Banking & Insurance'],\n  'trading': ['Banking & Insurance'],\n  'credit union': ['Banking & Insurance'],\n  'lending': ['Banking & Insurance'],\n  'payments': ['Banking & Insurance', 'Fintech'],\n  'payment processing': ['Banking & Insurance', 'Fintech'],\n  'crypto': ['Crypto', 'Fintech'],\n  'cryptocurrency': ['Crypto', 'Fintech'],\n  'cryptocurrencies': ['Crypto', 'Fintech'],\n  'blockchain': ['Crypto', 'Fintech'],\n  'web3': ['Crypto', 'Fintech'],\n  'defi': ['Crypto', 'Fintech'],\n  'nft': ['Crypto'],\n  'nfts': ['Crypto'],\n  'decentralized finance': ['Crypto', 'Fintech'],\n  \n  // Healthcare cluster\n  'healthcare': ['Healthcare'],\n  'health care': ['Healthcare'],\n  'health': ['Healthcare'],\n  'medical': ['Healthcare'],\n  'medicine': ['Healthcare'],\n  'hospital': ['Healthcare'],\n  'hospitals': ['Healthcare'],\n  'clinical': ['Healthcare'],\n  'clinic': ['Healthcare'],\n  'clinics': ['Healthcare'],\n  'patient': ['Healthcare'],\n  'patients': ['Healthcare'],\n  'healthtech': ['Healthcare'],\n  'health tech': ['Healthcare'],\n  'medtech': ['Healthcare'],\n  'med tech': ['Healthcare'],\n  'telemedicine': ['Healthcare'],\n  'telehealth': ['Healthcare'],\n  'ehr': ['Healthcare'],\n  'emr': ['Healthcare'],\n  'electronic health record': ['Healthcare'],\n  'electronic medical record': ['Healthcare'],\n  'pharma': ['Pharma', 'Healthcare'],\n  'pharmaceutical': ['Pharma', 'Healthcare'],\n  'pharmaceuticals': ['Pharma', 'Healthcare'],\n  'drug': ['Pharma'],\n  'drugs': ['Pharma'],\n  'biotech': ['Pharma', 'Healthcare'],\n  'biotechnology': ['Pharma', 'Healthcare'],\n  'life sciences': ['Pharma', 'Healthcare'],\n  'life science': ['Pharma', 'Healthcare'],\n  'clinical trials': ['Pharma', 'Healthcare'],\n  'dental': ['Dental', 'Healthcare'],\n  'dentist': ['Dental', 'Healthcare'],\n  'dentistry': ['Dental', 'Healthcare'],\n  'orthodontic': ['Dental', 'Healthcare'],\n  'orthodontics': ['Dental', 'Healthcare'],\n  \n  // Tech/Software cluster\n  'saas': ['SaaS'],\n  'software as a service': ['SaaS'],\n  'cloud software': ['SaaS'],\n  'subscription software': ['SaaS'],\n  'software': ['SaaS'],\n  'tech': ['SaaS'],\n  'technology': ['SaaS'],\n  'iot': ['IoT'],\n  'internet of things': ['IoT'],\n  'connected devices': ['IoT'],\n  'connected device': ['IoT'],\n  'smart home': ['IoT'],\n  'smart devices': ['IoT'],\n  'smart device': ['IoT'],\n  'embedded systems': ['IoT'],\n  'embedded system': ['IoT'],\n  'wearables': ['IoT'],\n  'wearable': ['IoT'],\n  'sensors': ['IoT'],\n  'big data': ['Big Data'],\n  'data analytics': ['Big Data'],\n  'data warehouse': ['Big Data'],\n  'data warehousing': ['Big Data'],\n  'data lake': ['Big Data'],\n  'business intelligence': ['Big Data'],\n  'bi': ['Big Data'],\n  'data engineering': ['Big Data'],\n  'analytics': ['Big Data'],\n  'data': ['Big Data'],\n  'telecom': ['Telecommunications'],\n  'telecoms': ['Telecommunications'],\n  'telecommunications': ['Telecommunications'],\n  'telecommunication': ['Telecommunications'],\n  'telco': ['Telecommunications'],\n  'mobile operator': ['Telecommunications'],\n  'mobile operators': ['Telecommunications'],\n  'carrier': ['Telecommunications'],\n  'carriers': ['Telecommunications'],\n  'network operator': ['Telecommunications'],\n  '5g': ['Telecommunications'],\n  'wireless': ['Telecommunications'],\n  \n  // Government cluster\n  'government': ['Government'],\n  'governments': ['Government'],\n  'gov': ['Government'],\n  'federal': ['Government'],\n  'federal government': ['Government'],\n  'state government': ['Government'],\n  'state agency': ['Government'],\n  'public sector': ['Government'],\n  'public': ['Government'],\n  'municipal': ['Government'],\n  'municipality': ['Government'],\n  'civic': ['Government'],\n  'civic tech': ['Government'],\n  'govtech': ['Government'],\n  'gov tech': ['Government'],\n  'public administration': ['Government'],\n  'regulatory': ['Regulatory'],\n  'regulation': ['Regulatory'],\n  'regulations': ['Regulatory'],\n  'regtech': ['Regulatory'],\n  'reg tech': ['Regulatory'],\n  'compliance': ['Regulatory'],\n  'legal tech': ['Regulatory'],\n  'legaltech': ['Regulatory'],\n  'legal': ['Regulatory'],\n  'aml': ['Regulatory', 'Banking & Insurance'],\n  'kyc': ['Regulatory', 'Banking & Insurance'],\n  'anti-money laundering': ['Regulatory', 'Banking & Insurance'],\n  'military': ['Military or Law Enforcement'],\n  'defense': ['Military or Law Enforcement'],\n  'defence': ['Military or Law Enforcement'],\n  'army': ['Military or Law Enforcement'],\n  'navy': ['Military or Law Enforcement'],\n  'air force': ['Military or Law Enforcement'],\n  'armed forces': ['Military or Law Enforcement'],\n  'law enforcement': ['Military or Law Enforcement'],\n  'police': ['Military or Law Enforcement'],\n  'security forces': ['Military or Law Enforcement'],\n  'homeland security': ['Military or Law Enforcement'],\n  'border security': ['Military or Law Enforcement'],\n  'security': ['Military or Law Enforcement'],\n  \n  // Retail/Commerce cluster\n  'e-commerce': ['E-commerce'],\n  'ecommerce': ['E-commerce'],\n  'e commerce': ['E-commerce'],\n  'online store': ['E-commerce'],\n  'online stores': ['E-commerce'],\n  'online shop': ['E-commerce'],\n  'online shopping': ['E-commerce'],\n  'online retail': ['E-commerce'],\n  'digital commerce': ['E-commerce'],\n  'marketplace': ['E-commerce'],\n  'marketplaces': ['E-commerce'],\n  'webshop': ['E-commerce'],\n  'web shop': ['E-commerce'],\n  'retail': ['Retail'],\n  'retailer': ['Retail'],\n  'retailers': ['Retail'],\n  'brick and mortar': ['Retail'],\n  'shopping': ['Retail'],\n  'store chain': ['Retail'],\n  'supermarket': ['Retail'],\n  'supermarkets': ['Retail'],\n  'grocery': ['Retail'],\n  'groceries': ['Retail'],\n  'department store': ['Retail'],\n  'stores': ['Retail'],\n  'fmcg': ['FMCG'],\n  'fast moving consumer goods': ['FMCG'],\n  'consumer goods': ['FMCG'],\n  'cpg': ['FMCG'],\n  'consumer packaged goods': ['FMCG'],\n  'consumer': ['FMCG'],\n  \n  // Media/Entertainment cluster\n  'media': ['Media'],\n  'media industry': ['Media'],\n  'news': ['Media'],\n  'journalism': ['Media'],\n  'broadcast': ['Media'],\n  'broadcasting': ['Media'],\n  'press': ['Media'],\n  'tv': ['Media'],\n  'television': ['Media'],\n  'radio': ['Media'],\n  'entertainment': ['Entertainment & Sports'],\n  'entertainment industry': ['Entertainment & Sports'],\n  'sports': ['Entertainment & Sports'],\n  'sport': ['Entertainment & Sports'],\n  'gaming': ['Entertainment & Sports'],\n  'games': ['Entertainment & Sports'],\n  'video games': ['Entertainment & Sports'],\n  'esports': ['Entertainment & Sports'],\n  'e-sports': ['Entertainment & Sports'],\n  'betting': ['Entertainment & Sports'],\n  'gambling': ['Entertainment & Sports'],\n  'casino': ['Entertainment & Sports'],\n  'casinos': ['Entertainment & Sports'],\n  'igaming': ['Entertainment & Sports'],\n  'lottery': ['Entertainment & Sports'],\n  'streaming': ['Streaming'],\n  'video streaming': ['Streaming'],\n  'music streaming': ['Streaming'],\n  'video platform': ['Streaming'],\n  'ott': ['Streaming'],\n  'over the top': ['Streaming'],\n  'vod': ['Streaming'],\n  'video on demand': ['Streaming'],\n  'social media': ['Social Media'],\n  'social network': ['Social Media'],\n  'social networks': ['Social Media'],\n  'social networking': ['Social Media'],\n  'publishing': ['Publishing'],\n  'publisher': ['Publishing'],\n  'publishers': ['Publishing'],\n  'editorial': ['Publishing'],\n  'magazine': ['Publishing'],\n  'magazines': ['Publishing'],\n  'newspaper': ['Publishing'],\n  'newspapers': ['Publishing'],\n  'book': ['Publishing'],\n  'books': ['Publishing'],\n  'content distribution': ['Content Distribution'],\n  'cdn': ['Content Distribution'],\n  'content delivery': ['Content Distribution'],\n  'content delivery network': ['Content Distribution'],\n  \n  // Travel/Hospitality\n  'travel': ['Hospitality or Travel'],\n  'travel industry': ['Hospitality or Travel'],\n  'tourism': ['Hospitality or Travel'],\n  'tourist': ['Hospitality or Travel'],\n  'tourists': ['Hospitality or Travel'],\n  'airline': ['Hospitality or Travel'],\n  'airlines': ['Hospitality or Travel'],\n  'aviation': ['Hospitality or Travel'],\n  'flight': ['Hospitality or Travel'],\n  'flights': ['Hospitality or Travel'],\n  'booking': ['Hospitality or Travel'],\n  'bookings': ['Hospitality or Travel'],\n  'hotel': ['Hospitality or Travel'],\n  'hotels': ['Hospitality or Travel'],\n  'hospitality': ['Hospitality or Travel'],\n  'hospitality industry': ['Hospitality or Travel'],\n  'vacation': ['Hospitality or Travel'],\n  'vacations': ['Hospitality or Travel'],\n  'holiday': ['Hospitality or Travel'],\n  'holidays': ['Hospitality or Travel'],\n  'resort': ['Hospitality or Travel'],\n  'resorts': ['Hospitality or Travel'],\n  'accommodation': ['Hospitality or Travel'],\n  'accommodations': ['Hospitality or Travel'],\n  'traveltech': ['Hospitality or Travel'],\n  'travel tech': ['Hospitality or Travel'],\n  'lodging': ['Hospitality or Travel'],\n  'airbnb': ['Hospitality or Travel'],\n  \n  // Education\n  'education': ['Education'],\n  'educational': ['Education'],\n  'edtech': ['Education'],\n  'ed-tech': ['Education'],\n  'ed tech': ['Education'],\n  'learning': ['Education'],\n  'e-learning': ['Education'],\n  'elearning': ['Education'],\n  'online learning': ['Education'],\n  'school': ['Education'],\n  'schools': ['Education'],\n  'university': ['Education'],\n  'universities': ['Education'],\n  'college': ['Education'],\n  'colleges': ['Education'],\n  'academic': ['Education'],\n  'academia': ['Education'],\n  'lms': ['Education'],\n  'learning management': ['Education'],\n  'training': ['Education'],\n  'corporate training': ['Education'],\n  'k-12': ['Education'],\n  'k12': ['Education'],\n  'higher education': ['Education'],\n  'student': ['Education'],\n  'students': ['Education'],\n  'teaching': ['Education'],\n  'tutoring': ['Education'],\n  \n  // Logistics/Transport\n  'logistics': ['Logistics'],\n  'logistics industry': ['Logistics'],\n  'supply chain': ['Logistics'],\n  'shipping': ['Logistics'],\n  'freight': ['Logistics'],\n  'warehouse': ['Logistics'],\n  'warehousing': ['Logistics'],\n  'warehouses': ['Logistics'],\n  'fulfillment': ['Logistics'],\n  'fulfilment': ['Logistics'],\n  'delivery': ['Logistics'],\n  'last mile': ['Logistics'],\n  'last-mile': ['Logistics'],\n  '3pl': ['Logistics'],\n  'third party logistics': ['Logistics'],\n  'fleet management': ['Logistics'],\n  'fleet': ['Logistics'],\n  'transport': ['Logistics'],\n  'transportation': ['Logistics'],\n  'courier': ['Logistics'],\n  'parcel': ['Logistics'],\n  'maritime': ['Maritime industry'],\n  'maritime industry': ['Maritime industry'],\n  'naval': ['Maritime industry'],\n  'port': ['Maritime industry'],\n  'ports': ['Maritime industry'],\n  'ocean': ['Maritime industry'],\n  'vessel': ['Maritime industry'],\n  'vessels': ['Maritime industry'],\n  'cargo ship': ['Maritime industry'],\n  'cargo ships': ['Maritime industry'],\n  'container shipping': ['Maritime industry'],\n  'marine': ['Maritime industry'],\n  'seafood': ['Maritime industry'],\n  'fishing': ['Maritime industry'],\n  'public transportation': ['Public Transportation'],\n  'public transport': ['Public Transportation'],\n  'transit': ['Public Transportation'],\n  'mass transit': ['Public Transportation'],\n  'bus': ['Public Transportation'],\n  'buses': ['Public Transportation'],\n  'train': ['Public Transportation'],\n  'trains': ['Public Transportation'],\n  'metro': ['Public Transportation'],\n  'subway': ['Public Transportation'],\n  'railway': ['Public Transportation'],\n  'railways': ['Public Transportation'],\n  'rail': ['Public Transportation'],\n  'automotive': ['Automotive'],\n  'automotive industry': ['Automotive'],\n  'car': ['Automotive'],\n  'cars': ['Automotive'],\n  'vehicle': ['Automotive'],\n  'vehicles': ['Automotive'],\n  'automobile': ['Automotive'],\n  'automobiles': ['Automotive'],\n  'ev': ['Automotive'],\n  'electric vehicle': ['Automotive'],\n  'electric vehicles': ['Automotive'],\n  'auto industry': ['Automotive'],\n  'autotech': ['Automotive'],\n  'auto tech': ['Automotive'],\n  'autonomous vehicles': ['Automotive'],\n  'self-driving': ['Automotive'],\n  'self driving': ['Automotive'],\n  'oem': ['Automotive'],\n  'auto': ['Automotive'],\n  'mobility': ['Automotive'],\n  \n  // Real Estate/Construction\n  'real estate': ['Real Estate'],\n  'realestate': ['Real Estate'],\n  'property': ['Real Estate'],\n  'properties': ['Real Estate'],\n  'proptech': ['Real Estate'],\n  'prop tech': ['Real Estate'],\n  'realty': ['Real Estate'],\n  'housing': ['Real Estate'],\n  'apartment': ['Real Estate'],\n  'apartments': ['Real Estate'],\n  'rental': ['Real Estate'],\n  'rentals': ['Real Estate'],\n  'mortgage': ['Real Estate', 'Banking & Insurance'],\n  'mortgages': ['Real Estate', 'Banking & Insurance'],\n  'commercial real estate': ['Real Estate'],\n  'residential real estate': ['Real Estate'],\n  'residential': ['Real Estate'],\n  'commercial': ['Real Estate'],\n  'civil engineering': ['Civil Engineering'],\n  'construction': ['Civil Engineering'],\n  'construction industry': ['Civil Engineering'],\n  'building': ['Civil Engineering'],\n  'buildings': ['Civil Engineering'],\n  'infrastructure': ['Civil Engineering'],\n  'architecture': ['Civil Engineering'],\n  'engineering': ['Civil Engineering'],\n  'contech': ['Civil Engineering'],\n  'construction tech': ['Civil Engineering'],\n  'structural': ['Civil Engineering'],\n  \n  // Food/Agriculture\n  'food': ['Food'],\n  'food industry': ['Food'],\n  'foodtech': ['Food'],\n  'food tech': ['Food'],\n  'food service': ['Food'],\n  'foodservice': ['Food'],\n  'restaurant': ['Food'],\n  'restaurants': ['Food'],\n  'catering': ['Food'],\n  'culinary': ['Food'],\n  'f&b': ['Food'],\n  'food & beverage': ['Food'],\n  'food and beverage': ['Food'],\n  'beverage': ['Food'],\n  'beverages': ['Food'],\n  'quick service restaurant': ['Food'],\n  'qsr': ['Food'],\n  'fast food': ['Food'],\n  'agriculture': ['Agriculture'],\n  'agricultural': ['Agriculture'],\n  'agritech': ['Agriculture'],\n  'agri-tech': ['Agriculture'],\n  'agri tech': ['Agriculture'],\n  'agtech': ['Agriculture'],\n  'farming': ['Agriculture'],\n  'farm': ['Agriculture'],\n  'farms': ['Agriculture'],\n  'agribusiness': ['Agriculture'],\n  'crop': ['Agriculture'],\n  'crops': ['Agriculture'],\n  'livestock': ['Agriculture'],\n  'dairy': ['Agriculture'],\n  'poultry': ['Agriculture'],\n  \n  // Business/Corporate\n  'hr': ['Human Resources'],\n  'human resources': ['Human Resources'],\n  'hr tech': ['Human Resources'],\n  'hrtech': ['Human Resources'],\n  'recruitment': ['Human Resources'],\n  'recruiting': ['Human Resources'],\n  'talent': ['Human Resources'],\n  'talent acquisition': ['Human Resources'],\n  'payroll': ['Human Resources'],\n  'workforce': ['Human Resources'],\n  'workforce management': ['Human Resources'],\n  'hris': ['Human Resources'],\n  'hcm': ['Human Resources'],\n  'human capital': ['Human Resources'],\n  'staffing': ['Human Resources'],\n  'hiring': ['Human Resources'],\n  'corporate': ['Corporate (HR, Legal, Finance,..)'],\n  'enterprise': ['Corporate (HR, Legal, Finance,..)'],\n  'b2b': ['B2B'],\n  'business to business': ['B2B'],\n  'business-to-business': ['B2B'],\n  'b2c': ['Retail', 'E-commerce'],\n  'business to consumer': ['Retail', 'E-commerce'],\n  'marketing': ['Marketing'],\n  'marketing industry': ['Marketing'],\n  'advertising': ['Marketing'],\n  'adtech': ['Marketing'],\n  'ad tech': ['Marketing'],\n  'ad-tech': ['Marketing'],\n  'digital marketing': ['Marketing'],\n  'martech': ['Marketing'],\n  'mar tech': ['Marketing'],\n  'seo': ['Marketing'],\n  'sem': ['Marketing'],\n  'ppc': ['Marketing'],\n  'affiliate marketing': ['Marketing'],\n  'email marketing': ['Marketing'],\n  'content marketing': ['Marketing'],\n  'branding': ['Marketing'],\n  'pr': ['Marketing'],\n  'public relations': ['Marketing'],\n  'ads': ['Marketing'],\n  'advertising': ['Marketing'],\n  \n  // Other\n  'furniture': ['Furniture'],\n  'furniture industry': ['Furniture'],\n  'interior': ['Furniture'],\n  'interior design': ['Furniture'],\n  'home goods': ['Furniture'],\n  'home decor': ['Furniture'],\n  'white label': ['White labeling'],\n  'white-label': ['White labeling'],\n  'whitelabel': ['White labeling'],\n  'white labeling': ['White labeling'],\n  'white labelling': ['White labeling']\n};\n\n// Context patterns that indicate the user wants to filter by industry experience\nconst contextPatterns = {\n  before: [\n    /(?:experience\\s+(?:in|with))\\s+$/i,\n    /(?:background\\s+in)\\s+$/i,\n    /(?:expertise\\s+in)\\s+$/i,\n    /(?:worked\\s+(?:in|at|for|on|with))\\s+$/i,\n    /(?:working\\s+(?:in|at|for|on|with))\\s+$/i,\n    /(?:works?\\s+(?:in|at|for|on|with))\\s+$/i,\n    /(?:from)\\s+$/i,\n    /(?:from\\s+(?:the\\s+)?)\\s*$/i,\n    /(?:for\\s+(?:a\\s+|the\\s+|an\\s+)?)\\s*$/i,\n    /(?:on\\s+(?:a\\s+|the\\s+|an\\s+)?)\\s*$/i,\n    /(?:in\\s+(?:the\\s+)?)\\s*$/i,\n    /(?:\\d+\\s+years?\\s+(?:in|of))\\s+$/i,\n    /(?:specialist\\s+in)\\s+$/i,\n    /(?:expert\\s+in)\\s+$/i,\n    /(?:focused\\s+on)\\s+$/i,\n    /(?:specialized\\s+in)\\s+$/i,\n    /(?:specializing\\s+in)\\s+$/i,\n    /(?:specialised\\s+in)\\s+$/i,\n    /(?:specialising\\s+in)\\s+$/i,\n    /(?:domain)\\s+$/i,\n    /(?:knowledge\\s+(?:in|of))\\s+$/i,\n    /(?:familiar\\s+with)\\s+$/i,\n    /(?:knows?)\\s+$/i,\n    /(?:understanding\\s+of)\\s+$/i,\n    // Multiple industries support (and, or, comma)\n    /(?:and)\\s+$/i,\n    /(?:or)\\s+$/i,\n    /(?:,)\\s*$/i,\n    /(?:&)\\s*$/i,\n  ],\n  after: [\n    /^\\s*(?:experience|background|expertise)/i,\n    /^\\s*(?:project|projects)/i,\n    /^\\s*(?:client|clients)/i,\n    /^\\s*(?:company|companies)/i,\n    /^\\s*(?:sector|industry|domain|space|field|vertical)/i,\n    /^\\s*(?:for\\s+\\d+\\s+years?)/i,\n    /^\\s*(?:knowledge)/i,\n    /^\\s*(?:specialist|expert)/i,\n    /^\\s*(?:focused|focus)/i,\n    /^\\s*(?:work|assignment|engagement)/i,\n    // Multiple industries support (and, or, comma)\n    /^\\s*(?:and|or)\\s+/i,\n    /^\\s*(?:,|&)\\s*/i,\n  ]\n};\n\n// Function to check if industry keyword has valid context\nconst hasValidContext = (input, keywordStart, keywordEnd) => {\n  const textBefore = input.substring(Math.max(0, keywordStart - 50), keywordStart);\n  const textAfter = input.substring(keywordEnd, Math.min(input.length, keywordEnd + 40));\n  \n  // Check before context\n  for (const pattern of contextPatterns.before) {\n    if (pattern.test(textBefore)) {\n      return true;\n    }\n  }\n  \n  // Check after context\n  for (const pattern of contextPatterns.after) {\n    if (pattern.test(textAfter)) {\n      return true;\n    }\n  }\n  \n  return false;\n};\n\n// Extract industries\nconst extractedIndustries = new Set();\n\n// Sort keywords by length (longest first) to match \"financial services\" before \"finance\"\nconst sortedKeywords = Object.keys(industryKeywords).sort((a, b) => b.length - a.length);\n\n// Track which positions have been matched to avoid double-counting\nconst matchedPositions = new Set();\n\nfor (const keyword of sortedKeywords) {\n  // Create regex for this keyword (escape special chars)\n  const escapedKeyword = keyword.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n  const keywordRegex = new RegExp(`\\\\b${escapedKeyword}\\\\b`, 'gi');\n  let match;\n  \n  while ((match = keywordRegex.exec(cleanInput)) !== null) {\n    const keywordStart = match.index;\n    const keywordEnd = match.index + match[0].length;\n    \n    // Check if this position was already matched by a longer keyword\n    let alreadyMatched = false;\n    for (let pos = keywordStart; pos < keywordEnd; pos++) {\n      if (matchedPositions.has(pos)) {\n        alreadyMatched = true;\n        break;\n      }\n    }\n    \n    if (alreadyMatched) continue;\n    \n    // Check if this keyword has valid context\n    if (hasValidContext(cleanInput, keywordStart, keywordEnd)) {\n      // Mark positions as matched\n      for (let pos = keywordStart; pos < keywordEnd; pos++) {\n        matchedPositions.add(pos);\n      }\n      \n      // Add canonical industries\n      industryKeywords[keyword].forEach(ind => extractedIndustries.add(ind));\n    }\n  }\n}\n\n// Return results\nreturn {\n  json: {\n    industries: Array.from(extractedIndustries)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        -608
      ],
      "id": "1b7b0f52-678a-42c2-aeac-a3e227e7f4c7",
      "name": "Industries Regex"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "knowledge",
        "options": {
          "ignoreBots": false
        }
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -3872,
        -256
      ],
      "id": "af32705a-5f1a-472a-b006-413568c513d1",
      "webhookId": "9c2c018b-0c4e-47aa-a3b3-d969f38c78a4"
    },
    {
      "parameters": {
        "channel": "={{ $('Format Request').first().json.requestData.event.channel }}",
        "text": "={{ $json.text }}",
        "otherOptions": {
          "mrkdwn": true
        },
        "attachments": []
      },
      "name": "Send Slack Response",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        1472,
        -608
      ],
      "id": "7586544a-72df-4d80-bc00-ba6faebc353c",
      "credentials": {
        "slackApi": {
          "id": "AEq4vJ003HpIV8va",
          "name": "Resourcing Bot"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "requestData",
              "value": "={{ $('Webhook').item.json.body }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Format Request",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -2880,
        -368
      ],
      "id": "d20f09f9-7366-45e6-899e-4be0fdc9577d"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b7457277-ce5a-444d-a04c-b43adb27b812",
              "leftValue": "={{ $json.body.event.bot_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3632,
        -256
      ],
      "id": "d3fb7b8d-b8c7-4dc9-8b13-a3814fc862b1",
      "name": "If not a bot"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3360,
        -80
      ],
      "id": "0ac258b8-acc1-4c99-be5a-d52f7e90a6e9",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "jsCode": "const generateSlackMarkdownDirectPrompt = (queryResults, originalChat, sqlExecuted) => {\n  const systemPrompt = `You are a helpful HR assistant presenting database query results conversationally for Slack.\n\nGOAL:\n- Take structured query results about people (name, role, skills, etc.)\n- Understand what the user is really asking\n- Answer in clean, concise Slack mrkdwn (NOT JSON)\n\nTONE & BEHAVIOR:\n1. Be conversational but professional\n2. Use actual names and numbers from the data\n3. Don't just dump data - interpret and summarize\n4. Highlight important patterns or insights\n5. Keep responses concise but complete\n7. Never mention SQL, databases, or technical details\n8. Never mention JSON, schemas, or \"response_type\"\n9. Do not give any suggestions, just observations when needed.\n\nSLACK MRKDWN RULES (different from standard markdown):\n- Bold: *text* (single asterisk, NOT double)\n- Italic: _text_ (underscore)\n- Strikethrough: ~text~\n- Code: \\`text\\`\n- Code block: \\`\\`\\`text\\`\\`\\`\n- Links: <url|text>\n- Line breaks: Just use newlines\n- Lists: Use â€¢ or - with spaces\n- NO ## headers (Slack doesn't support them)\n- NO **double asterisks** for bold\n\nGENERAL OUTPUT RULES:\n1. Output ONLY Slack mrkdwn - no JSON, no wrapping, no explanations\n2. Be concise - busy people should get the answer in 2 seconds\n3. Use emoji for visual hierarchy\n4. Never mention \"query results\", \"records\", or technical processing\n5. Keep it scannable and clean\n\nEMPLOYMENT TYPE ICONS:\n- ğŸ¢ = Employee (internal staff)\n- ğŸ¤ = Contractor (external)\n\nCHOOSE A RESPONSE PATTERN:\nBased on the user's question, internally decide ONE main style:\n- \"count\" â†’ for \"how many\" questions\n- \"list\" â†’ for \"show me\", \"list\", \"who\" questions\n- \"search\" â†’ for \"find\", \"need\", \"looking for\" questions\n- \"comparison\" â†’ for \"best\", \"top\", \"compare\" questions\n- \"breakdown\" â†’ for analysis/distribution questions\n- \"no_results\" â†’ when no matches found\n\nTHEN FORMAT LIKE THIS (do NOT show labels like \"response_type\"):\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A COUNT-TYPE ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\n[If you have any notable observations, add a brief note with ğŸ’¡]\n\nExample structure (adapt it):\n*We found 8 backend engineers in the pool.*\n\nMost of them are mid-level, with a few seniors available next month.\nğŸ’¡ Many have experience in fintech and microservices.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A LIST or SEARCH-TYPE ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\n[For each person in highlights, up to 10 people:]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ *[name]* â€” [role], [seniority]\n     ğŸ¢ Employee  OR  ğŸ¤ Contractor\n     ğŸ› ï¸ [key_skills as comma-separated]\n     ğŸ­ [industries as comma-separated]\n     [If certs exist:] ğŸ“œ [certificates as comma-separated]\n     [If description exists:] ğŸ“ _[brief description, max 1-2 sentences]_\n     [If a reason stands out:] âœ¨ _[why this person fits the request]_\n\n[If more than 10 relevant people exist, add a short note, e.g.:\nâ€¦plus X more matching profiles.]\n\n[If you have insights:]\nğŸ’¡ *Insights:* [insights as comma-separated or short phrases]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A COMPARISON / \"BEST\" / \"TOP\" ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\nğŸ† *Top Matches:*\n\n[For each person, numbered:]\n*[1. Name]* â€” [role], [seniority]\n     ğŸ¢ Employee  OR  ğŸ¤ Contractor\n     ğŸ› ï¸ [key_skills as comma-separated]\n     ğŸ­ [industries as comma-separated]\n     [If certs exist:] ğŸ“œ [certificates]\n     [If description exists:] ğŸ“ _[brief description]_\n     [If relevant:] âœ¨ _[why they are a strong match]_\n\n[Optional: One short insights block]\nğŸ’¡ *Insights:* [1â€“3 short observations]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A BREAKDOWN / ANALYSIS ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\nğŸ“Š *Breakdown:*\nâ€¢ [category]: [count or %]\nâ€¢ [category]: [count or %]\nâ€¢ [category]: [count or %]\n\n[Optional insights]\nğŸ’¡ *Insights:* [1â€“3 short observations]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF THERE ARE NO RESULTS:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]* ğŸ˜•\n\n[main_response]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSLACK FORMATTING REMINDERS:\nâ€¢ Bold = *single asterisks* NOT **double**\nâ€¢ Use â€” (em dash) instead of - for separators in text\nâ€¢ Use â€¢ for bullet points\nâ€¢ Use â”â”â” line for visual separation between people\nâ€¢ Indent with spaces (5 spaces) for sub-info under names\nâ€¢ Keep lines short - Slack wraps awkwardly on long lines\nâ€¢ Max 10 people in the detailed list, mention if more exist\nâ€¢ No headers - use *bold* with emoji instead\nâ€¢ Do NOT mention \"response_type\" explicitly, just follow the matching pattern\nâ€¢ ğŸ¢ for Employee, ğŸ¤ for Contractor\nâ€¢ Only show ğŸ“œ certs line if certificates exist\nâ€¢ Only show ğŸ“ description line if description exists and is meaningful`;\n\n  const userPrompt = `USER ASKED:\n\"${originalChat}\"\n\nDATA AVAILABLE (${queryResults.length} records shown, max 15 below):\n${JSON.stringify(queryResults.slice(0, 15), null, 2)}\n${queryResults.length > 15 ? `\\n... and ${queryResults.length - 15} more results` : ''}\n\nFIELD REFERENCE:\n- name: person's name\n- role: job role\n- seniority: level (Senior 1, Mid 2, etc.)\n- employment_type: \"Employee\" or \"Contractor\" (use ğŸ¢ or ğŸ¤)\n- skills_senior, skills_medium, skills_junior: their skills by proficiency\n- industries: industry experience\n- certs: certificates/certifications (optional, may be null or empty)\n- description: additional notes about the person (optional, may be null or empty)\n\nIf the data is empty or has no relevant matches, treat it as a \"no results\" case.\n\nUsing the rules and templates above:\n- Decide the most appropriate response style (count, list, search, comparison, breakdown, or no_results)\n- Write a single clean Slack message in mrkdwn\n- Be concise, but specific and helpful\n- Do NOT mention SQL or technical details\n- Do NOT include any JSON or code blocks\n- Only include certs/description lines if they have actual content\n\nOUTPUT THE SLACK MRKDWN NOW (no backticks, no explanation).`;\n\n  return {\n    systemPrompt,\n    userPrompt\n  };\n};\n\n// Usage in n8n\nconst queryResults = $input.all().map(item => item.json);\nconst originalChat = $('ChatInput').first().json.chatInput;\nconst sqlExecuted = $('AI Agent1').first().json.output; // optional, not used directly above\n\nconst slackPrompt = generateSlackMarkdownDirectPrompt(queryResults, originalChat, sqlExecuted);\n\nreturn {\n  json: {\n    slackPrompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        -608
      ],
      "id": "fbc126bc-c670-460b-8325-24980ee2ed6d",
      "name": "Prompt for Markdown"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -4192,
        880
      ],
      "id": "5b866c62-9534-46c6-aadd-909352835cb0",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "channel": "={{ $('Format Request').item.json.requestData.event.channel }}",
        "text": "={{ $json.slackMessage }}",
        "otherOptions": {
          "mrkdwn": true
        },
        "attachments": []
      },
      "name": "Send Slack Response - Gibberish1",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        -1504,
        -224
      ],
      "id": "ad3b3133-80aa-4da4-8162-5fa6e13a83b7",
      "credentials": {
        "slackApi": {
          "id": "AEq4vJ003HpIV8va",
          "name": "Resourcing Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Array of 20 humorous responses for nonsensical input\nconst funnyResponses = [\n  \"I'm fluent in gibberish too!\",\n  \"is that you, Shakespeare?\",\n  \"I think my circuits just did a somersault.\",\n  \"even my cat didn't understand that.\",\n  \"are we speaking in code now?\",\n  \"I love a good riddle, but I'm stumped!\",\n  \"you've discovered the secret language of the universe!\",\n  \"if I had a nickel for every time I heard that...\",\n  \"is this an elaborate prank?\",\n  \"I feel like we're on different wavelengths.\",\n  \"my brain just did a backflip.\",\n  \"are we playing charades?\",\n  \"I need a decoder ring for that one.\",\n  \"that's a new one for me!\",\n  \"I'm picking up what you're laying down... I think.\",\n  \"is this the latest trend in communication?\",\n  \"I might need a translator for that.\",\n  \"you're keeping me on my toes!\",\n  \"I appreciate your creativity!\",\n  \"let's try that again in a language I know.\"\n];\n\n// Select a random response from the array\nconst randomResponse = funnyResponses[Math.floor(Math.random() * funnyResponses.length)];\n\n// Slack-friendly suggestions message\nconst suggestions = `\nğŸ’¡ *Try something like:*\nâ€¢ _\"Find senior React developers with AWS experience\"_\nâ€¢ _\"How many Python engineers do we have?\"_\nâ€¢ _\"List contractors who worked in healthcare\"_\nâ€¢ _\"Show me mobile developers with Flutter skills\"_\nâ€¢ _\"Who knows Angular and worked in fintech?\"_`;\n\n// Combined Slack message\nconst slackMessage = `ğŸ¤” Hmm... ${randomResponse}\n${suggestions}`;\n\n// Return both items\nreturn {\n  json: {\n    funnyResponse: randomResponse,\n    suggestions: suggestions,\n    slackMessage: slackMessage\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1696,
        -224
      ],
      "id": "a4add0df-39e0-4b17-8b1e-620554690b82",
      "name": "Random response1"
    },
    {
      "parameters": {
        "jsCode": "const checkResourcingIntent = (userInput) => {\n  const systemPrompt = `You classify if a message is about finding/searching employees, staff, or resources. \n\nIf YES (valid request): Answer only true\nIf NO (invalid request): Answer with false\n`;\n\n  const userPrompt = `Is this a request to find, list, count, or search for employees/people/resources/developers/engineers/staff?\n\n\"${userInput}\"\n\nIf valid resource search â†’ respond: true\nIf not â†’ respond with: false + the helpful Slack message`;\n\n  return { systemPrompt, userPrompt };\n};\n\n// Usage\nconst prompt = checkResourcingIntent($('ChatInput').first().json.chatInput);\n\nreturn {\n  json: {\n    prompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2480,
        -368
      ],
      "id": "29a9e515-729f-4d95-9cd2-812ad6abd90d",
      "name": "Prompt For Gibberish check"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "qwen3-coder-30b-32k",
          "mode": "list",
          "cachedResultName": "qwen3-coder-30b-32k"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2240,
        -176
      ],
      "id": "4805f979-fef0-46e7-9c43-092c5dbb670a",
      "name": "Qwen3 30b1",
      "credentials": {
        "openAiApi": {
          "id": "09tIxrZPXx1gwPgx",
          "name": "vllm"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n    \"cleanInput\": true\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -2096,
        -176
      ],
      "id": "7dc9a07a-5546-4ed9-9631-e73d388e81d7",
      "name": "JSON1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.prompt.userPrompt }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.prompt.systemPrompt }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -2240,
        -368
      ],
      "id": "f851607c-968e-4c07-bea9-e9512a6376bc",
      "name": "Check gibberish"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f9ef2811-15b5-4dba-9b41-5e3b7c99c597",
              "leftValue": "={{ $json.output.cleanInput }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1936,
        -368
      ],
      "id": "43d4e2c7-dc1d-40e2-99f3-99a0017c9f3c",
      "name": "Is clean?"
    },
    {
      "parameters": {
        "jsCode": "const generateSlackMarkdownDirectPrompt = (queryResults, originalChat, sqlExecuted) => {\n  const systemPrompt = `You are a helpful HR assistant presenting database query results conversationally for Slack.\n\nGOAL:\n- Take structured query results about people (name, role, skills, etc.)\n- Understand what the user is really asking\n- Answer in clean, concise Slack mrkdwn (NOT JSON)\n\nTONE & BEHAVIOR:\n1. Be conversational but professional\n2. Use actual names and numbers from the data\n3. Don't just dump data - interpret and summarize\n4. Highlight important patterns or insights\n5. Keep responses concise but complete\n7. Never mention SQL, databases, or technical details\n8. Never mention JSON, schemas, or \"response_type\"\n9. Do not give any suggestions, just observations when needed.\n\nSLACK MRKDWN RULES (different from standard markdown):\n- Bold: *text* (single asterisk, NOT double)\n- Italic: _text_ (underscore)\n- Strikethrough: ~text~\n- Code: \\`text\\`\n- Code block: \\`\\`\\`text\\`\\`\\`\n- Links: <url|text>\n- Line breaks: Just use newlines\n- Lists: Use â€¢ or - with spaces\n- NO ## headers (Slack doesn't support them)\n- NO **double asterisks** for bold\n\nGENERAL OUTPUT RULES:\n1. Output ONLY Slack mrkdwn - no JSON, no wrapping, no explanations\n2. Be concise - busy people should get the answer in 2 seconds\n3. Use emoji for visual hierarchy\n4. Never mention \"query results\", \"records\", or technical processing\n5. Keep it scannable and clean\n\nCHOOSE A RESPONSE PATTERN:\nBased on the user's question, internally decide ONE main style:\n- \"count\" â†’ for \"how many\" questions\n- \"list\" â†’ for \"show me\", \"list\", \"who\" questions\n- \"search\" â†’ for \"find\", \"need\", \"looking for\" questions\n- \"comparison\" â†’ for \"best\", \"top\", \"compare\" questions\n- \"breakdown\" â†’ for analysis/distribution questions\n- \"no_results\" â†’ when no matches found\n\nTHEN FORMAT LIKE THIS (do NOT show labels like \"response_type\"):\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A COUNT-TYPE ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\n[If you have any notable observations, add a brief note with ğŸ’¡]\n\nExample structure (adapt it):\n*We found 8 backend engineers in the pool.*\n\nMost of them are mid-level, with a few seniors available next month.\nğŸ’¡ Many have experience in fintech and microservices.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A LIST or SEARCH-TYPE ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\n[For each person in highlights, up to 10 people:]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ *[name]* â€” [role], [seniority]\n     ğŸ“Œ [employment_type]\n     ğŸ› ï¸ [key_skills as comma-separated]\n     ğŸ¢ [industries as comma-separated]\n     [If a reason stands out:] âœ¨ _[why this person fits the request]_\n\n[If more than 10 relevant people exist, add a short note, e.g.:\nâ€¦plus X more matching profiles.]\n\n[If you have insights:]\nğŸ’¡ *Insights:* [insights as comma-separated or short phrases]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A COMPARISON / \"BEST\" / \"TOP\" ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\nğŸ† *Top Matches:*\n\n[For each person, numbered:]\n*[1. Name]* â€” [role], [seniority]\n     ğŸ“Œ [employment_type] | ğŸ› ï¸ [key_skills as comma-separated]\n     ğŸ¢ [industries as comma-separated]\n     [If relevant:] âœ¨ _[why they are a strong match]_\n\n[Optional: One short insights block]\nğŸ’¡ *Insights:* [1â€“3 short observations]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF IT'S A BREAKDOWN / ANALYSIS ANSWER:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]*\n\n[main_response]\n\nğŸ“Š *Breakdown:*\nâ€¢ [category]: [count or %]\nâ€¢ [category]: [count or %]\nâ€¢ [category]: [count or %]\n\n[Optional insights]\nğŸ’¡ *Insights:* [1â€“3 short observations]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nIF THERE ARE NO RESULTS:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n*[summary]* ğŸ˜•\n\n[main_response]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSLACK FORMATTING REMINDERS:\nâ€¢ Bold = *single asterisks* NOT **double**\nâ€¢ Use â€” (em dash) instead of - for separators in text\nâ€¢ Use â€¢ for bullet points\nâ€¢ Use â”â”â” line for visual separation between people\nâ€¢ Indent with spaces (5 spaces) for sub-info under names\nâ€¢ Keep lines short - Slack wraps awkwardly on long lines\nâ€¢ Max 10 people in the detailed list, mention if more exist\nâ€¢ No headers - use *bold* with emoji instead\nâ€¢ Do NOT mention \"response_type\" explicitly, just follow the matching pattern`;\n\n  const userPrompt = `USER ASKED:\n\"${originalChat}\"\n\nDATA AVAILABLE (${queryResults.length} records shown, max 15 below):\n${JSON.stringify(queryResults.slice(0, 15), null, 2)}\n${queryResults.length > 15 ? `\\n... and ${queryResults.length - 15} more results` : ''}\n\nIf the data is empty or has no relevant matches, treat it as a \"no results\" case.\n\nUsing the rules and templates above:\n- Decide the most appropriate response style (count, list, search, comparison, breakdown, or no_results)\n- Write a single clean Slack message in mrkdwn\n- Be concise, but specific and helpful\n- Do NOT mention SQL or technical details\n- Do NOT include any JSON or code blocks\n\nOUTPUT THE SLACK MRKDWN NOW (no backticks, no explanation).`;\n\n  return {\n    systemPrompt,\n    userPrompt\n  };\n};\n\n// Usage in n8n\nconst queryResults = $input.all().map(item => item.json);\nconst originalChat = $('ChatInput').first().json.chatInput;\nconst sqlExecuted = $('AI Agent1').first().json.output; // optional, not used directly above\n\nconst slackPrompt = generateSlackMarkdownDirectPrompt(queryResults, originalChat, sqlExecuted);\n\nreturn {\n  json: {\n    slackPrompt\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        -784
      ],
      "id": "21c05ab1-b8b8-47be-b30e-5f7ca633b46d",
      "name": "Prompt for Markdown1"
    },
    {
      "parameters": {
        "channel": "={{ $('Webhook').first().json.body.event.channel }}",
        "text": "=You are not authorised to use this application. Contact Resourcing for further help.",
        "otherOptions": {
          "mrkdwn": true
        },
        "attachments": []
      },
      "name": "Unauthorised",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        -2864,
        -176
      ],
      "id": "68038500-c6cf-479f-8f4d-e37edfc87083",
      "credentials": {
        "slackApi": {
          "id": "AEq4vJ003HpIV8va",
          "name": "Resourcing Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "21JoYPCMCSs0Ocop",
          "mode": "list",
          "cachedResultName": "Resourcing_Ids",
          "cachedResultUrl": "/projects/NM7VZoSXkcKo262s/datatables/21JoYPCMCSs0Ocop"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "slack_id",
              "keyValue": "={{ $json.body.event.user }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -3408,
        -448
      ],
      "id": "41e8d9b2-181c-42e7-864b-8242edbcc98e",
      "name": "Authorised?",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "24e19116-ef5d-4981-b901-60856236dde9",
              "leftValue": "={{$input.first().json.isEmpty()}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3216,
        -400
      ],
      "id": "4f71d14e-8043-470d-a047-89b78fc3af14",
      "name": "Authorised?1",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1wxfjciOQxLGUSm-_cyWCNGfHmOWMejlQsbZ5FSZsPfI",
          "mode": "list",
          "cachedResultName": "Resourcing Logs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1wxfjciOQxLGUSm-_cyWCNGfHmOWMejlQsbZ5FSZsPfI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1wxfjciOQxLGUSm-_cyWCNGfHmOWMejlQsbZ5FSZsPfI/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Query": "={{ $('ChatInput').first().json.chatInput }}",
            "Response": "={{ $('Response in Markdown').first().json.text }}",
            "User": "={{ $('Authorised?').first().json.name }}",
            "Date": "={{ $now.format('yyyy-MM-dd HH:mm') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Query",
              "displayName": "Query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Response",
              "displayName": "Response",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "User",
              "displayName": "User",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1680,
        -608
      ],
      "id": "0eee5be3-53dd-4183-8504-6e4a525724a0",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "VqBZlK3vKXeQiMtM",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/api/resources/search",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3520,
        688
      ],
      "id": "c2ccb257-f013-4ceb-b8db-98bda23b5d8c",
      "name": "Search",
      "webhookId": "fc861439-0243-408a-b7db-672979835983"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.query }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2896,
        688
      ],
      "id": "998101a1-d78c-427b-9986-c8496329bd2e",
      "name": "Execute a SQL query1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wK2pSCG9jTniRU28",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -2480,
        688
      ],
      "id": "d0771486-3039-40ee-87a3-dbd6ad2a5efc",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "url": "https://planner.ganttic.com/api/v1/resources/datafields",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "9062f2555255d4e42a69eb2c54bbbcf61a61e03d2881f4480ea3a5e0e842b8f8"
            },
            {
              "name": "includeEmptyDataFields",
              "value": "0"
            },
            {
              "name": "includeReadableDataFieldValues",
              "value": "1"
            },
            {
              "name": "page",
              "value": "={{ $json.page }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c6eeb82f-43cb-4caa-be7e-237621b93a05",
      "name": "Fetch Ganttic Properties",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -3152,
        1040
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "410fa6fb-963d-49ff-89a5-312ff85ddc6b",
              "name": "industries",
              "value": "={{ $json.multiSelect[0].values }}",
              "type": "array"
            },
            {
              "id": "ec1de577-c485-4b2c-a7e4-0587cd548ae5",
              "name": "roles",
              "value": "={{ $json.listValues[1].values }}",
              "type": "array"
            },
            {
              "id": "b1e027b7-54bc-4dff-9d84-c4621b2f7b69",
              "name": "skills",
              "value": "={{ $json.multiSelect[1].values }}",
              "type": "array"
            },
            {
              "id": "930b849e-b3b1-4ff2-b7a3-a05d7a398912",
              "name": "certificates",
              "value": "={{ $json.multiSelect[4].values }}",
              "type": "array"
            },
            {
              "id": "321802c8-dc83-44fe-8b85-5f4e6b62f433",
              "name": "verticals",
              "value": "={{ $json.listValues[17].values }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2944,
        1040
      ],
      "id": "f37bd295-3862-4f9f-8070-8191b4ff7bfa",
      "name": "Get Properties"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -2720,
        1040
      ],
      "id": "02e8a23d-d19a-4bb2-8959-1167d5eec219",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "path": "resourcing_get_properties",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3440,
        1040
      ],
      "id": "22974b89-8ca8-4347-b661-43dd4c97573c",
      "name": "Filters",
      "webhookId": "80ec34df-e777-4086-a430-c72ab0144f4f"
    },
    {
      "parameters": {
        "jsCode": "// Function node to process incoming request\nconst body = $input.first().json.body;\n\n// Extract filters with defaults\nconst filters = body.filters || {};\nconst search = body.search || {};\nconst options = body.options || {};\n\n// Pass through all array filters directly\nconst processedFilters = {\n  role: filters.role?.length > 0 ? filters.role : null,\n  seniority: filters.seniority?.length > 0 ? filters.seniority : null,\n  skills: filters.skills?.length > 0 ? filters.skills : null,\n  industries: filters.industries?.length > 0 ? filters.industries : null,\n  employment_type: filters.employment_type?.length > 0 ? filters.employment_type : null,\n  vertical: filters.vertical?.length > 0 ? filters.vertical : null,\n  domain: filters.domain?.length > 0 ? filters.domain : null,\n  certificates: filters.certificates?.length > 0 ? filters.certificates : null\n};\n\n// Remove null values\nObject.keys(processedFilters).forEach(key => {\n  if (processedFilters[key] === null) delete processedFilters[key];\n});\n\nreturn {\n  json: {\n    filters: processedFilters,\n    search: {\n      query: search.query || null,\n      use_semantic: search.use_semantic || false\n    },\n    options: {\n      limit: options.limit || 50,\n      min_similarity: options.min_similarity || 0.3,\n      include_availability: options.include_availability || false\n    },\n    timestamp: Date.now()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3312,
        688
      ],
      "id": "598ffcf7-cce7-42da-b7d1-e0de72da9ff2",
      "name": "Proces rest api input"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst filters = input.filters || {};\nconst options = input.options || {};\n\n// Helper to escape single quotes for SQL safety\nconst esc = (val) => val ? val.replace(/'/g, \"''\") : '';\n\n// Build WHERE clauses\nconst conditions = [];\n\n// Role filter (OR logic)\nif (filters.role?.length > 0) {\n  const roleConditions = filters.role.map(r => `role ILIKE '%${esc(r)}%'`);\n  conditions.push(`(${roleConditions.join(' OR ')})`);\n}\n\n// Seniority filter (OR logic)\nif (filters.seniority?.length > 0) {\n  const seniorityConditions = filters.seniority.map(s => `seniority ILIKE '%${esc(s)}%'`);\n  conditions.push(`(${seniorityConditions.join(' OR ')})`);\n}\n\n// Skills filter (OR logic across all skill levels)\nif (filters.skills?.length > 0) {\n  const skillConditions = filters.skills.map(skill => `(\n    EXISTS (SELECT 1 FROM unnest(skills_senior) s WHERE s ILIKE '%${esc(skill)}%') OR\n    EXISTS (SELECT 1 FROM unnest(skills_medium) s WHERE s ILIKE '%${esc(skill)}%') OR\n    EXISTS (SELECT 1 FROM unnest(skills_junior) s WHERE s ILIKE '%${esc(skill)}%')\n  )`);\n  conditions.push(`(${skillConditions.join(' OR ')})`);\n}\n\n// Industries filter (OR logic)\nif (filters.industries?.length > 0) {\n  const industryConditions = filters.industries.map(ind => \n    `EXISTS (SELECT 1 FROM unnest(industries) i WHERE i ILIKE '%${esc(ind)}%')`\n  );\n  conditions.push(`(${industryConditions.join(' OR ')})`);\n}\n\n// Employment type filter (OR logic)\nif (filters.employment_type?.length > 0) {\n  const empConditions = filters.employment_type.map(e => `employment_type ILIKE '%${esc(e)}%'`);\n  conditions.push(`(${empConditions.join(' OR ')})`);\n}\n\n// Certificates filter (OR logic)\nif (filters.certificates?.length > 0) {\n  const certConditions = filters.certificates.map(cert => \n    `EXISTS (SELECT 1 FROM unnest(certs) c WHERE c ILIKE '%${esc(cert)}%')`\n  );\n  conditions.push(`(${certConditions.join(' OR ')})`);\n}\n\n// Vertical filter (OR logic)\nif (filters.vertical?.length > 0) {\n  const verticalConditions = filters.vertical.map(v => `vertical ILIKE '%${esc(v)}%'`);\n  conditions.push(`(${verticalConditions.join(' OR ')})`);\n}\n\n// Build final query\nconst whereClause = conditions.length > 0 \n  ? `WHERE ${conditions.join(' AND ')}` \n  : '';\n\nconst query = `SELECT * FROM ganttic_api_resources ${whereClause} LIMIT ${options.limit || 50}`;\n\nreturn {\n  json: {\n    query: query,\n    filters: filters,\n    search: input.search,\n    options: options,\n    timestamp: input.timestamp\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3104,
        688
      ],
      "id": "e70e22d6-9ffe-4f23-aa64-0ff3e85af127",
      "name": "Generate Query"
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(item => item.json);\nconst request = $('Search').first().json; // Adjust node name\n\n// Transform each result to response schema\nconst transformedResults = results.map(r => {\n  const matchReasons = [];\n  \n  // Check role match\n  if (request.filters?.role?.some(role => r.role?.toLowerCase().includes(role.toLowerCase()))) {\n    matchReasons.push('Exact role match');\n  }\n  \n  // Check seniority match\n  if (request.filters?.seniority?.some(sen => r.seniority?.toLowerCase().includes(sen.toLowerCase()))) {\n    matchReasons.push(`Seniority: ${r.seniority}`);\n  }\n  \n  // Check skills match\n  if (request.filters?.skills) {\n    for (const skill of request.filters.skills) {\n      const skillLower = skill.toLowerCase();\n      if (r.skills_senior?.some(s => s.toLowerCase().includes(skillLower))) {\n        matchReasons.push(`Senior ${skill}`);\n      } else if (r.skills_medium?.some(s => s.toLowerCase().includes(skillLower))) {\n        matchReasons.push(`Mid ${skill}`);\n      } else if (r.skills_junior?.some(s => s.toLowerCase().includes(skillLower))) {\n        matchReasons.push(`Junior ${skill}`);\n      }\n    }\n  }\n  \n  // Check industry match\n  if (request.filters?.industries) {\n    const matchedIndustries = r.industries?.filter(ind => \n      request.filters.industries.some(reqInd => ind.toLowerCase().includes(reqInd.toLowerCase()))\n    ) || [];\n    if (matchedIndustries.length > 0) {\n      matchReasons.push(`${matchedIndustries.join(', ')} experience`);\n    }\n  }\n  \n  // Check certificates match\n  if (request.filters?.certificates) {\n    const matchedCerts = r.certs?.filter(cert => \n      request.filters.certificates.some(reqCert => cert.toLowerCase().includes(reqCert.toLowerCase()))\n    ) || [];\n    if (matchedCerts.length > 0) {\n      matchReasons.push(`Certified: ${matchedCerts.join(', ')}`);\n    }\n  }\n\n  return {\n    resource_id: r.id,\n    resource_name: r.name,\n    role_category: r.role,\n    seniority_level: r.seniority,\n    technical_domain: r.section,\n    skills: {\n      senior: r.skills_senior || [],\n      mid: r.skills_medium || [],\n      junior: r.skills_junior || []\n    },\n    industries: r.industries || [],\n    certificates: r.certs || [],\n    employment_type: r.employment_type,\n    vertical: r.vertical,\n    description: r.description,\n    notes: r.notes,\n    el: r.el,\n    eh: r.eh,\n    director: r.director,\n    department: r.department,\n    image_url: r.image_url,\n    email: r.email,\n    similarity_score: null,\n    match_reasons: matchReasons\n  };\n});\n\nconst response = {\n  success: true,\n  count: transformedResults.length,\n  filters_applied: {\n    role: request.filters?.role || null,\n    seniority: request.filters?.seniority || null,\n    skills: request.filters?.skills || null,\n    industries: request.filters?.industries || null,\n    employment_type: request.filters?.employment_type || null,\n    certificates: request.filters?.certificates || null\n  },\n  results: transformedResults,\n  metadata: {\n    query_time_ms: Date.now() - (request.timestamp || Date.now()),\n    semantic_search_used: request.search?.use_semantic || false\n  }\n};\n\nreturn {\n  json: response\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2688,
        688
      ],
      "id": "05cc7f03-3938-4a4d-bc4f-5595b3381055",
      "name": "Generate Output"
    },
    {
      "parameters": {
        "url": "https://planner.ganttic.com/api/v1/resources",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "9062f2555255d4e42a69eb2c54bbbcf61a61e03d2881f4480ea3a5e0e842b8f8"
            },
            {
              "name": "includeEmptyDataFields",
              "value": "0"
            },
            {
              "name": "includeReadableDataFieldValues",
              "value": "1"
            },
            {
              "name": "page",
              "value": "={{ $json.page }}"
            }
          ]
        },
        "options": {}
      },
      "id": "22ecda7b-2597-4c87-a7e5-18d53a8f3fb6",
      "name": "Fetch Ganttic Resources",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2736,
        1536
      ]
    },
    {
      "parameters": {
        "tableId": "ganttic_api_resources",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "id",
              "fieldValue": "={{ $('Process Resources').item.json.id }}"
            },
            {
              "fieldId": "name",
              "fieldValue": "={{ $('Process Resources').item.json.name }}"
            },
            {
              "fieldId": "skills_senior",
              "fieldValue": "={{ $('Process Resources').item.json.skills_senior }}"
            },
            {
              "fieldId": "industries",
              "fieldValue": "={{ $('Process Resources').item.json.industry }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $('Process Resources').item.json.description }}"
            },
            {
              "fieldId": "skills_medium",
              "fieldValue": "={{ $('Process Resources').item.json.skills_medium }}"
            },
            {
              "fieldId": "skills_junior",
              "fieldValue": "={{ $('Process Resources').item.json.skills_junior }}"
            },
            {
              "fieldId": "section",
              "fieldValue": "={{ $('Process Resources').item.json.section }}"
            },
            {
              "fieldId": "seniority",
              "fieldValue": "={{ $('Process Resources').item.json.seniority }}"
            },
            {
              "fieldId": "team",
              "fieldValue": "={{ $('Process Resources').item.json.team }}"
            },
            {
              "fieldId": "department",
              "fieldValue": "={{ $('Process Resources').item.json.department }}"
            },
            {
              "fieldId": "vertical",
              "fieldValue": "={{ $('Process Resources').item.json.vertical }}"
            },
            {
              "fieldId": "coe_manager",
              "fieldValue": "={{ $('Process Resources').item.json.coe_manager }}"
            },
            {
              "fieldId": "el",
              "fieldValue": "={{ $('Process Resources').item.json.el }}"
            },
            {
              "fieldId": "eh",
              "fieldValue": "={{ $('Process Resources').item.json.eh }}"
            },
            {
              "fieldId": "director",
              "fieldValue": "={{ $('Process Resources').item.json.director }}"
            },
            {
              "fieldId": "employment_type",
              "fieldValue": "={{ $('Process Resources').item.json.employment_type }}"
            },
            {
              "fieldId": "certs",
              "fieldValue": "={{ $('Process Resources').item.json.certs }}"
            },
            {
              "fieldId": "notes",
              "fieldValue": "={{ $('Process Resources').item.json.note }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "={{ $('Process Resources').item.json.role }}"
            },
            {
              "fieldId": "primary_skill",
              "fieldValue": "={{ $('Process Resources').item.json.primary_skill }}"
            },
            {
              "fieldId": "=email",
              "fieldValue": "={{ $('Process Resources').item.json.email }}"
            },
            {
              "fieldId": "image_url",
              "fieldValue": "={{ $('Get image url1').item.json.image_url }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2000,
        1536
      ],
      "id": "aa67d8e1-2f7a-4c14-b11a-313d9144c6a0",
      "name": "Resources - INSERT",
      "credentials": {
        "supabaseApi": {
          "id": "Vbtfas1bVCzZ2Wde",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process resources\nconst item = items[0];\nconst resources = item.json.items || [];\n\nreturn resources.map(resource => {\n  // skills senior\n  const skills_senior = [];\n  const ssFields = resource.dataFields?.multiSelect?.find(t => t.id === '124830');\n  if (ssFields?.values) {\n      ssFields.values.forEach(v => {\n          if (v.readableValue && !skills_senior.includes(v.readableValue)) {\n              skills_senior.push(v.readableValue);\n          }\n      });\n  }\n  // skills midium\n  const skills_medium = [];\n  const smFields = resource.dataFields?.multiSelect?.find(t => t.id === '124831');\n  if (smFields?.values) {\n      smFields.values.forEach(v => {\n          if (v.readableValue && !skills_medium.includes(v.readableValue)) {\n              skills_medium.push(v.readableValue);\n          }\n      });\n  }\n\n  // skills junior\n  const skills_junior = [];\n  const sjFields = resource.dataFields?.multiSelect?.find(t => t.id === '124832');\n  if (sjFields?.values) {\n      sjFields.values.forEach(v => {\n          if (v.readableValue && !skills_junior.includes(v.readableValue)) {\n              skills_junior.push(v.readableValue);\n          }\n      });\n  }\n\n  // get certs\n  const certs = [];\n  const certFields = resource.dataFields?.multiSelect?.find(t => t.id === '126853');\n  if (certFields?.values) {\n      certFields.values.forEach(v => {\n          if (v.readableValue && !certs.includes(v.readableValue)) {\n              certs.push(v.readableValue);\n          }\n      });\n  }\n  \n  // Extract industries\n  const industriesarr = [];\n  const industryField = resource.dataFields?.multiSelect?.find(ms => \n      ms.readableValue === 'Industry Expertise'\n  );\n  if (industryField?.values) {\n    industryField.values.forEach(v => {\n      if (v.readableValue) {\n        industriesarr.push(v.readableValue);\n      }\n    });\n  }\n\n  // Get description\n  const descField = resource.dataFields?.texts?.find(t => t.id === '121631');\n  let description = descField?.text ?? '';\n\n  // Get notes\n  const noteField = resource.dataFields?.texts?.find(t => t.id === '123740');\n  let note = noteField?.text ?? '';\n\n\n  // Get Section\n  const secField = resource.dataFields.listValues?.find(t => t.id === '114287');\n  let section = secField?.readableValue ?? '';\n\n  const roleField = resource.dataFields.listValues?.find(t => t.id === '114312');\n  let role = roleField?.readableValue ?? '';\n\n  const primary_skill_field = resource.dataFields.listValues?.find(t => t.id === '121223');\n  let primary_skill = primary_skill_field?.readableValue ?? '';\n\n  // Get seniority\n  const senField = resource.dataFields?.listValues?.find(t => t.id === '115797')\n  let seniority = senField?.readableValue ?? '';\n\n  // Get team\n  const teamField = resource.dataFields?.listValues?.find(t => t.id === '120128')\n  let team = teamField?.readableValue ?? '';\n  \n  // Get department\n  const departmentField = resource.dataFields?.listValues?.find(t => t.id === '124673')\n  let department = departmentField?.readableValue ?? '';\n  \n  // Get vertical\n  const verticalField = resource.dataFields?.listValues?.find(t => t.id === '124674')\n  let vertical = verticalField?.readableValue ?? '';\n  \n  // Get coe_manager\n  const coe_managerField = resource.dataFields?.listValues?.find(t => t.id === '124407')\n  let coe_manager = coe_managerField?.readableValue ?? '';\n  \n  // Get el\n  const elField = resource.dataFields?.listValues?.find(t => t.id === '124300')\n  let el = elField?.readableValue ?? '';\n  \n  // Get eh\n  const ehField = resource.dataFields?.listValues?.find(t => t.id === '124301')\n  let eh = ehField?.readableValue ?? '';\n  \n  // Get director\n  const directorField = resource.dataFields?.listValues?.find(t => t.id === '124302')\n  let director = directorField?.readableValue ?? '';\n  \n  // Get employment_type\n  const employment_typeField = resource.dataFields?.listValues?.find(t => t.id === '124741')\n  let employment_type = employment_typeField?.readableValue ?? '';\n\n\n  /**\n   * Zlatko import for post processing and embed prep\n   */\n\n  // Extract all available fields from the input\n  const resourceId = resource.id;\n  const resourceName = resource.name;\n  const technicalDomain = section;\n  const globalSeniority = seniority;\n  const coeManager = coe_manager;\n  const engineeringLead = el;\n  const engineeringHead = eh;\n  const employmentType = employment_type;\n  const skillSeniorLevel = skills_senior.join(\", \") || \"\";\n  const skillMidLevel = skills_medium.join(\", \") || \"\"\n  const skillJuniorLevel = skills_junior.join(\", \") || \"\";\n  const industryExpertise = industriesarr.join(\", \") || \"\";\n  const domainKnowledge = description;\n  const certificates = certs.join(\", \") || \"\";\n    \n\n      // Universal parser function that handles parentheses, brackets, and quoted text\n    const smartParse = (textString) => {\n        if (!textString) return [];\n        \n        const results = [];\n        let currentItem = '';\n        let insideParentheses = 0;  // Track nested parentheses\n        let insideBrackets = 0;     // Track nested brackets\n        let insideQuotes = false;   // Track quoted text\n        \n        // Process character by character\n        for (let i = 0; i < textString.length; i++) {\n            const char = textString[i];\n            \n            // Handle different states\n            if (char === '(') {\n                insideParentheses++;\n                currentItem += char;\n            } else if (char === ')') {\n                insideParentheses = Math.max(0, insideParentheses - 1); // Guard against mismatched parentheses\n                currentItem += char;\n            } else if (char === '[') {\n                insideBrackets++;\n                currentItem += char;\n            } else if (char === ']') {\n                insideBrackets = Math.max(0, insideBrackets - 1); // Guard against mismatched brackets\n                currentItem += char;\n            } else if (char === '\"' || char === \"'\") {\n                insideQuotes = !insideQuotes;\n                currentItem += char;\n            } else if (char === ',' && !insideParentheses && !insideBrackets && !insideQuotes) {\n                // Only split on commas when not inside special characters\n                results.push(currentItem.trim());\n                currentItem = '';\n            } else {\n                currentItem += char;\n            }\n        }\n        \n        // Add the last item if there is one\n        if (currentItem.trim()) {\n            results.push(currentItem.trim());\n        }\n        \n        // Post-processing: Handle special formats and clean up\n        return results\n            .map(item => {\n                // Clean up quote marks if they balance at beginning/end\n                if ((item.startsWith('\"') && item.endsWith('\"')) || \n                    (item.startsWith(\"'\") && item.endsWith(\"'\"))) {\n                    item = item.slice(1, -1).trim();\n                }\n                \n                // Remove any trailing dots or punctuation\n                return item.replace(/[.,;]+$/, '').trim();\n            })\n            .filter(Boolean);\n    };\n    \n    const cleanField = (text) => {\n    if (!text) return text;\n    \n    // Remove redundant whitespace\n    text = text.replace(/\\s+/g, ' ').trim();\n    \n    // Only include entries that actually need standardization\n    const standardizations = {\n        // JavaScript variations\n        'Javascript': 'JavaScript',\n        'JS': 'JavaScript',\n        'TS': 'TypeScript',\n        'React.js': 'React',\n        'React.JS': 'React',\n        'ReactJS': 'React',\n        'NextJS': 'Next.js',\n        'VueJS': 'Vue.js',\n        'Vue3': 'Vue.js',\n        'AngularJS': 'Angular',\n        'NodeJS': 'Node.js',\n        'ExpressJS': 'Express',\n        'NestJS': 'Nest.js',\n        'NuxtJS': 'Nuxt.js',\n        \n        // Python variations\n        'Python3': 'Python',\n        'Fast API': 'FastAPI',\n        'Pandas': 'pandas',\n        'NumPy': 'numpy',\n        'Scikit-learn': 'scikit-learn',\n        'sklearn': 'scikit-learn',\n        'Pytest': 'pytest',\n        'PyTest': 'pytest',\n        \n        // Java variations\n        'J2EE': 'Java EE',\n        'SpringBoot': 'Spring Boot',\n        \n        // .NET variations\n        '.Net': '.NET',\n        'DotNet': '.NET',\n        'CSharp': 'C#',\n        'C sharp': 'C#',\n        'ASP.Net': 'ASP.NET',\n        'EF Core': 'Entity Framework Core',\n        \n        // PHP variations\n        'WP': 'WordPress',\n        \n        // Ruby variations\n        'Rails': 'Ruby on Rails',\n        'RoR': 'Ruby on Rails',\n        \n        // Go variations\n        'Golang': 'Go',\n        'Go lang': 'Go',\n        'Rust lang': 'Rust',\n        \n        // Mobile variations\n        'Obj-C': 'Objective-C',\n        \n        // Database variations\n        'Postgres': 'PostgreSQL',\n        'Mongo': 'MongoDB',\n        'Elastic': 'Elasticsearch',\n        'Oracle DB': 'Oracle',\n        'MSSQL': 'SQL Server',\n        'MS SQL': 'SQL Server',\n        \n        // Cloud variations\n        'Amazon Web Services': 'AWS',\n        'Microsoft Azure': 'Azure',\n        'Google Cloud': 'GCP',\n        'Google Cloud Platform': 'GCP',\n        'K8s': 'Kubernetes',\n        'Argo CD': 'ArgoCD',\n        'ELK': 'ELK Stack',\n        \n        // AI/ML variations\n        'Artificial Intelligence': 'AI',\n        'Machine Learning': 'ML',\n        'Natural Language Processing': 'NLP',\n        'HuggingFace': 'Hugging Face',\n        'Large Language Models': 'LLM',\n        'Lang Chain': 'LangChain',\n        'Vector DB': 'Vector Database',\n        \n        // Data variations\n        'Apache Spark': 'Spark',\n        'Apache Kafka': 'Kafka',\n        'Apache Airflow': 'Airflow',\n        'Apache Hadoop': 'Hadoop',\n        'Apache Flink': 'Flink',\n        'Apache NiFi': 'NiFi',\n        \n        // Architecture variations\n        'Service Oriented Architecture': 'SOA',\n        'RESTful': 'REST',\n        'WebSockets': 'WebSocket',\n        'Event Driven': 'Event-Driven',\n        'Domain Driven Design': 'DDD',\n        'Test Driven Development': 'TDD',\n        'Behavior Driven Development': 'BDD',\n        'CI / CD': 'CI/CD',\n        'Devops': 'DevOps',\n        \n        // UI/UX variations\n        'UI/UX': 'UI/UX',\n        \n        // General variations\n        'Front-end': 'Frontend',\n        'Front end': 'Frontend',\n        'Back-end': 'Backend',\n        'Back end': 'Backend',\n        'Fullstack': 'Full Stack',\n        'Full-stack': 'Full Stack',\n        'Full stack': 'Full Stack',\n        'APIs': 'API',\n        \n        // Automation variations\n        'N8N': 'n8n',\n        'AzureLogicApps': 'Azure Logic Apps',\n        'Azure LogicApps': 'Azure Logic Apps',\n        'Integromat': 'Make',\n      \n        // AI-specific (from your actual data: \"AI - LLM\", \"AI - RAG\")\n        'Generative AI': 'GenAI',\n        'Gen AI': 'GenAI',\n        'Prompting': 'Prompt Engineering', // already clean\n        'LLMs': 'LLM',\n        'Langsmith': 'LangSmith',\n        'Vector Database': 'VectorDB',\n        'Vector DB': 'VectorDB',\n        'embeddings': 'Embeddings',\n\n        // Data Science tools (from description field)\n        'pandas': 'pandas', // already lowercase\n        'geopandas': 'GeoPandas',\n        'matplotlib': 'Matplotlib',\n        'seaborn': 'Seaborn',\n        'plotly': 'Plotly',\n        'boosting/bagging': 'Boosting/Bagging',\n\n        // Missing framework variations\n        'fast-api': 'FastAPI',\n\n        // Missing cloud/tools\n        'gitlab': 'GitLab',\n        'Git Lab': 'GitLab',\n\n        // Certifications (common variations)\n        'Certificate AWS': 'AWS Certified',\n        'Certificate Azure': 'Azure Certified',\n        'AWS Cert': 'AWS Certified',\n        'Azure Cert': 'Azure Certified'\n    };\n    \n    // Apply standardizations\n    Object.keys(standardizations).forEach(key => {\n        const regex = new RegExp(`\\\\b${key}\\\\b`, 'gi');\n        text = text.replace(regex, standardizations[key]);\n    });\n    \n    return text;\n};\n    \n    const extractRoleCategory = (technicalDomain) => {\n    if (!technicalDomain) return \"Other\";\n    \n    const domainLower = technicalDomain.toLowerCase().trim();\n    \n    // Direct mappings for common abbreviations\n    const directMappings = {\n        'ba': 'Business Analyst',\n        'pm': 'Project Manager',\n        'po': 'Product Owner',\n        'sa': 'Solution Architect',\n        'qa': 'QA Engineer',\n        'fe': 'Frontend Developer',\n        'be': 'Backend Developer',\n        'fs': 'Full Stack Developer',\n        'do': 'DevOps Engineer',\n        'de': 'Data Engineer',\n        'ds': 'Data Scientist',\n        'ml': 'ML Engineer',\n        'ai': 'AI Engineer',\n        'ux': 'UX Designer',\n        'ui': 'UI Designer',\n        'se': 'Support Engineer',\n        'pe': 'Presales Engineer',\n        'ta': 'Technical Architect',\n        'tl': 'Tech Lead',\n        'em': 'Engineering Manager',\n        'sm': 'Scrum Master'\n    };\n    \n    // Check direct mappings first\n    if (directMappings[domainLower]) {\n        return directMappings[domainLower];\n    }\n    \n    // Then check for keyword matches\n    if (domainLower.includes('business analyst')) return 'Business Analyst';\n    if (domainLower.includes('project manager')) return 'Project Manager';\n    if (domainLower.includes('product owner')) return 'Product Owner';\n    if (domainLower.includes('solution architect')) return 'Solution Architect';\n    \n    if (domainLower.includes('frontend') || \n        domainLower.includes('react') || \n        domainLower.includes('angular') || \n        domainLower.includes('vue') || \n        domainLower.includes('slice')) {\n        return 'Frontend Developer';\n    }\n    \n    if (domainLower.includes('backend') || \n        domainLower.includes('java') || \n        domainLower.includes('php') || \n        domainLower.includes('python') || \n        domainLower.includes('.net') || \n        domainLower.includes('node') || \n        domainLower.includes('ruby') ||\n        domainLower.includes('cms')) {\n        return 'Backend Developer';\n    }\n    \n    if (domainLower.includes('fullstack') || \n        domainLower.includes('full stack') || \n        domainLower.includes('full-stack')) {\n        return 'Full Stack Developer';\n    }\n    \n    if (domainLower.includes('mobile') || \n        domainLower.includes('android') || \n        domainLower.includes('ios') || \n        domainLower.includes('flutter') || \n        domainLower.includes('react native')) {\n        return 'Mobile Developer';\n    }\n    \n    if (domainLower.includes('devops') || \n        domainLower.includes('sre') || \n        domainLower.includes('infrastructure') || \n        domainLower.includes('cloud')) {\n        return 'DevOps Engineer';\n    }\n    \n    if (domainLower.includes('test') || \n        domainLower.includes('quality')) {\n        return 'QA Engineer';\n    }\n    \n    if (domainLower.includes('data scientist') || \n        domainLower.includes('data science')) {\n        return 'Data Scientist';\n    }\n    \n    if (domainLower.includes('data') || \n        domainLower.includes('bi') || \n        domainLower.includes('business intelligence')) {\n        return 'Data Engineer';\n    }\n    \n    if (domainLower.includes('machine learning') || \n        domainLower.includes('ai engineer')) {\n        return 'AI/ML Engineer';\n    }\n    \n    if (domainLower.includes('design') || \n        domainLower.includes('ux') || \n        domainLower.includes('ui')) {\n        return 'UI/UX Designer';\n    }\n    \n    if (domainLower.includes('support')) {\n        return 'Support Engineer';\n    }\n    \n    if (domainLower.includes('presales') || \n        domainLower.includes('pre-sales')) {\n        return 'Presales Engineer';\n    }\n    \n    // Return the original if no mapping found\n    return technicalDomain;\n};\n    \nconst extractTechnicalDetails = (domainKnowledge) => {\n    if (!domainKnowledge) return { tools: [], technologies: [], methodologies: [] };\n    \n    // Expanded based on your actual data\n    const tools = [\n        // Project Management & Collaboration\n        'Jira', 'Confluence', 'Azure DevOps', 'GitHub', 'GitLab', 'Bitbucket',\n        'Slack', 'Microsoft Teams', 'Asana', 'Trello', 'Monday', 'Notion', 'Linear',\n        \n        // CI/CD & DevOps Tools\n        'Jenkins', 'TeamCity', 'Travis CI', 'CircleCI', 'Bamboo', 'GitHub Actions',\n        'ArgoCD', 'Terraform', 'Ansible', 'Puppet', 'Chef', 'Helm',\n        \n        // Design Tools\n        'Figma', 'Sketch', 'Adobe XD', 'InVision', 'Zeplin', 'Framer',\n        'Axure', 'Adobe Photoshop', 'Adobe Illustrator', 'InDesign',\n        \n        // Analytics & Monitoring\n        'Power BI', 'Tableau', 'Looker', 'Grafana', 'Kibana', 'Datadog',\n        'New Relic', 'Splunk', 'Prometheus', 'ELK Stack',\n        \n        // Testing & Development Tools\n        'Postman', 'Swagger', 'SonarQube', 'Selenium', 'Cypress', 'Jest',\n        'VS Code', 'IntelliJ', 'Eclipse', 'Xcode', 'Android Studio',\n        \n        // Documentation & Modeling\n        'BPMN', 'UML', 'Draw.io', 'Lucidchart', 'Miro', 'Mural'\n    ];\n    \n    const technologies = [\n        // Frontend\n        'React', 'Angular', 'Vue', 'Next.js', 'Nuxt', 'Svelte', 'jQuery',\n        'Bootstrap', 'Tailwind', 'Material UI', 'Ant Design',\n        \n        // Backend\n        'Node.js', 'Express', 'Django', 'Flask', 'FastAPI', 'Spring Boot', \n        'Laravel', 'Symfony', 'ASP.NET', 'Ruby on Rails', 'Gin', 'Echo',\n        \n        // Databases\n        'MongoDB', 'PostgreSQL', 'MySQL', 'SQL Server', 'Oracle', 'Redis',\n        'DynamoDB', 'Cassandra', 'Neo4j', 'Elasticsearch', 'Supabase', 'Firebase',\n        \n        // Cloud & Infrastructure\n        'Docker', 'Kubernetes', 'AWS', 'Azure', 'GCP', 'Vercel', 'Netlify',\n        'CloudFlare', 'DigitalOcean', 'Heroku',\n        \n        // AI/ML - Based on your actual data\n        'TensorFlow', 'PyTorch', 'Keras', 'scikit-learn', 'pandas', 'NumPy',\n        'Hugging Face', 'HuggingFace', 'LangChain', 'Langchain', 'OpenAI',\n        'Anthropic', 'Gemini', 'LLM', 'RAG', 'Stable Diffusion',\n        'matplotlib', 'seaborn', 'plotly', 'geopandas', 'scipy',\n        'boosting', 'bagging', 'XGBoost', 'LightGBM',\n        \n        // Data Engineering\n        'Hadoop', 'Spark', 'Kafka', 'Airflow', 'Databricks', 'Snowflake',\n        'dbt', 'Flink', 'Storm', 'Beam',\n        \n        // APIs & Architecture\n        'REST', 'GraphQL', 'SOAP', 'gRPC', 'WebSocket', 'Microservices',\n        'API Gateway', 'Service Mesh', 'Event-Driven',\n        \n        // Mobile\n        'React Native', 'Flutter', 'Swift', 'Kotlin', 'Xamarin', 'Ionic',\n        \n        // Other\n        'Blockchain', 'Web3', 'Solidity', 'Smart Contracts',\n        'ERP', 'CRM', 'Salesforce', 'SAP', 'ServiceNow',\n        'Payment Gateway', 'Stripe', 'PayPal', 'Square'\n    ];\n    \n    const methodologies = [\n        // Development Methodologies\n        'Agile', 'Scrum', 'Kanban', 'SAFe', 'Waterfall', 'Lean', 'XP',\n        'DevOps', 'DevSecOps', 'GitOps', 'MLOps', 'DataOps',\n        \n        // Development Practices\n        'CI/CD', 'TDD', 'BDD', 'DDD', 'SOLID', 'Clean Code', 'Clean Architecture',\n        'Pair Programming', 'Code Review', 'Continuous Integration',\n        'Continuous Deployment', 'Blue-Green Deployment', 'Canary Deployment',\n        \n        // Architecture Patterns\n        'Microservices', 'Serverless', 'Event-Driven', 'CQRS', 'Event Sourcing',\n        'Hexagonal Architecture', 'Onion Architecture', 'MVC', 'MVP', 'MVVM',\n        \n        // Design & Research\n        'User Research', 'Design Thinking', 'User-Centered Design', 'Design Sprint',\n        'A/B Testing', 'Usability Testing', 'Persona Development',\n        \n        // Data Practices\n        'Data Modeling', 'ETL', 'ELT', 'Data Warehousing', 'OLAP', 'OLTP',\n        'Data Lake', 'Data Mesh', 'Data Governance',\n        \n        // Product & Business\n        'Product Discovery', 'User Story Mapping', 'Requirements Elicitation',\n        'Business Analysis', 'Product Ownership', 'Stakeholder Management',\n        'OKRs', 'KPIs', 'Roadmapping'\n    ];\n    \n    // Improved matching function - case insensitive but preserves original case\n    const findMatches = (text, terms) => {\n        const matches = [];\n        const lowerText = text.toLowerCase();\n        \n        terms.forEach(term => {\n            // Use word boundaries for more accurate matching\n            const regex = new RegExp(`\\\\b${term.toLowerCase()}\\\\b`, 'i');\n            if (regex.test(lowerText)) {\n                matches.push(term);\n            }\n        });\n        \n        return [...new Set(matches)]; // Remove duplicates\n    };\n    \n    return {\n        tools: findMatches(domainKnowledge, tools),\n        technologies: findMatches(domainKnowledge, technologies),\n        methodologies: findMatches(domainKnowledge, methodologies)\n    };\n};\n    \n    // Determine seniority level based on Global Seniority \n    const determineSeniorityLevel = (globalSeniority) => {\n        // If global seniority is not available, return unknown\n        if (!globalSeniority) return \"Unknown\";\n        \n        const seniorityLower = globalSeniority.toLowerCase();\n        \n        if (seniorityLower.includes('senior')) {\n            // Extract number if available (e.g., \"Senior 2\" -> 2)\n            const seniorityNum = seniorityLower.match(/\\d+/);\n            if (seniorityNum) {\n                return `Senior ${seniorityNum[0]}`;\n            }\n            return \"Senior\";\n        }\n        \n        if (seniorityLower.includes('mid')) {\n            // Extract number if available (e.g., \"Mid 2\" -> 2)\n            const midNum = seniorityLower.match(/\\d+/);\n            if (midNum) {\n                return `Mid ${midNum[0]}`;\n            }\n            return \"Mid\";\n        }\n        \n        if (seniorityLower.includes('junior')) {\n            // Extract number if available (e.g., \"Junior 2\" -> 2)\n            const juniorNum = seniorityLower.match(/\\d+/);\n            if (juniorNum) {\n                return `Junior ${juniorNum[0]}`;\n            }\n            return \"Junior\";\n        }\n        \n        if (seniorityLower.includes('head')) {\n            return \"Head\";\n        }\n        \n        if (seniorityLower.includes('manager')) {\n            return \"Manager\";\n        }\n        \n        // Return original if no mapping\n        return globalSeniority;\n    };\n    \n    // Determine if the person is a manager or lead\n    const isLeadOrManager = (globalSeniority, engineeringLead, coeManager) => {\n        if (!globalSeniority && !engineeringLead && !coeManager) return false;\n        \n        // Check if global seniority indicates management position\n        if (globalSeniority && (\n            globalSeniority.toLowerCase().includes('manager') ||\n            globalSeniority.toLowerCase().includes('head')\n        )) {\n            return true;\n        }\n        \n        // Check if they are listed as engineering lead for anyone\n        if (engineeringLead && engineeringLead === resourceName) {\n            return true;\n        }\n        \n        // Check if they are listed as COE manager for anyone\n        if (coeManager && coeManager === resourceName) {\n            return true;\n        }\n        \n        return false;\n    };\n    \n    // Create skills arrays\n    const skills = {\n        senior: smartParse(skillSeniorLevel).map(cleanField),\n        mid: smartParse(skillMidLevel).map(cleanField),\n        junior: smartParse(skillJuniorLevel).map(cleanField)\n    };\n    \n    // Extract all skills for quick access and filtering\n    const allSkills = [\n        ...skills.senior.map(skill => ({ skill, level: 'senior' })),\n        ...skills.mid.map(skill => ({ skill, level: 'mid' })),\n        ...skills.junior.map(skill => ({ skill, level: 'junior' }))\n    ];\n    \n    // Get flat list of skills\n    const flatSkills = allSkills.map(s => s.skill);\n    \n    // Extract technical details from domain knowledge\n    const technicalDetails = extractTechnicalDetails(domainKnowledge);\n    \n    // Add extracted technical details to all_skills if not already present\n    technicalDetails.tools.forEach(tool => {\n        if (!flatSkills.includes(tool)) {\n            flatSkills.push(tool);\n        }\n    });\n    \n    technicalDetails.technologies.forEach(tech => {\n        if (!flatSkills.includes(tech)) {\n            flatSkills.push(tech);\n        }\n    });\n    \n    technicalDetails.methodologies.forEach(method => {\n        if (!flatSkills.includes(method)) {\n            flatSkills.push(method);\n        }\n    });\n    \nconst identifyPrimarySkillAreas = (allSkills) => {\n    const skillGroups = {\n        'Frontend': [\n            'JS - React', 'JS - Angular', 'JS - Vue', 'JS - Next', 'JS - Nuxt',\n            'React', 'Angular', 'Vue', 'JavaScript', 'TypeScript', \n            'HTML', 'CSS', 'Web - HTML/CSS', 'Web Slice/CSS/HTML',\n            'SASS', 'LESS', 'Redux', 'Next.js', 'Tailwind', 'Bootstrap'\n        ],\n        'Backend': [\n            'Java - Spring Boot', 'Java - J2EE', 'Python - Django', 'Python - Flask', \n            'Python - FastAPI', 'PHP - Laravel', 'PHP - Symfony', 'Ruby - Rails',\n            'C# - .NET Core', 'C# - .NET Framework', 'Node - Express', 'Node - Nest',\n            'GO - gin', 'GO - beego', 'Java', 'Spring', 'Python', 'Django', \n            'PHP', 'Laravel', 'C#', '.NET', 'Node.js', 'Express', 'Ruby', 'Rails'\n        ],\n        'CMS': [\n            'CMS - WordPress', 'CMS - Drupal', 'CMS - Craft', 'CMS - Strapi',\n            'WordPress', 'Drupal', 'Magento', 'WooCommerce'\n        ],\n        'Database': [\n            'SQL', 'PostgreSQL', 'MySQL', 'MongoDB', 'DynamoDB', \n            'Elasticsearch', 'Redis', 'Cassandra', 'Oracle', 'Supabase',\n            'DB - PostgreSQL', 'DB - MySQL', 'DB - MongoDB'\n        ],\n        'DevOps': [\n            'DevOps - AWS', 'DevOps - Azure', 'DevOps - CI/CD', 'DevOps - Linux',\n            'DevOps - Docker', 'DevOps - Kubernetes', 'Docker', 'Kubernetes', \n            'AWS', 'Azure', 'GCP', 'CI/CD', 'Jenkins', 'Terraform', 'Ansible'\n        ],\n        'Mobile': [\n            'Android', 'iOS', 'Flutter', 'React Native', 'Swift', 'Kotlin',\n            'Kotlin - Spring Boot', 'C# - Unity', 'Xamarin'\n        ],\n        'AI/ML': [\n            'AI - LLM', 'AI - RAG', 'AI - Prompting', 'AI - GenAI', 'AI - NLP',\n            'AI - Data Prep', 'AI - n8n', 'Python - DataScience', 'Python - ML',\n            'TensorFlow', 'PyTorch', 'ML', 'AI', 'NLP', 'Computer Vision', \n            'Data Science', 'Data Scientist', 'Hugging Face', 'LangChain'\n        ],\n        'Testing': [\n            'QA - Automated', 'QA - Manual', 'QA - Functional', 'QA - Non-functional',\n            'QA', 'Selenium', 'Cypress', 'Jest', 'Testing', 'TDD', 'BDD', \n            'JUnit', 'PyTest', 'Postman'\n        ],\n        'Management': [\n            'Project Management', 'Product Owner', 'Business Analysis',\n            'Solution Architect', 'Agile', 'Scrum', 'Kanban', \n            'JIRA', 'Confluence'\n        ],\n        'Design': [\n            'Design - UI', 'Design - UX', 'UI', 'UX', 'Figma', 'Sketch', \n            'Adobe XD', 'Photoshop', 'Illustrator', 'Zeplin'\n        ],\n        'Data': [\n            'Data Engineer', 'Data Engineering', 'Python - DataEngineering',\n            'ETL', 'Spark', 'Kafka', 'Airflow', 'Databricks', 'BigQuery'\n        ]\n    };\n    \n    // Count occurrences - exact match or contains\n    const areaScores = {};\n    Object.keys(skillGroups).forEach(area => {\n        areaScores[area] = 0;\n        skillGroups[area].forEach(skill => {\n            allSkills.forEach(userSkill => {\n                // Exact match first\n                if (userSkill === skill) {\n                    areaScores[area] += 2; // Higher weight for exact match\n                }\n                // Then check if contains (for partial matches)\n                else if (userSkill.toLowerCase().includes(skill.toLowerCase()) || \n                         skill.toLowerCase().includes(userSkill.toLowerCase())) {\n                    areaScores[area]++;\n                }\n            });\n        });\n    });\n    \n    // Return areas with at least one skill match, sorted by score\n    const matchedAreas = Object.keys(areaScores)\n        .filter(area => areaScores[area] > 0)\n        .sort((a, b) => areaScores[b] - areaScores[a]);\n    \n    return matchedAreas;\n};\n    \n    // Get role category from technical domain\n    const roleCategory = extractRoleCategory(technicalDomain);\n    \n    // Get seniority level\n    const seniorityLevel = determineSeniorityLevel(globalSeniority);\n    \n    // Check if the person is a lead or manager\n    const isLeadOrManagerRole = isLeadOrManager(globalSeniority, engineeringLead, coeManager);\n    \n    // Get primary skill areas\n    const primarySkillAreas = identifyPrimarySkillAreas(flatSkills);\n    \n    // Parse industries\n    const industries = smartParse(industryExpertise).map(cleanField);\n    \n    // Parse certificates\n    const certificatesList = smartParse(certificates).map(cleanField);\n    \n    // Extract organizational structure\n    const orgStructure = {\n        team: team,\n        department: department,\n        vertical: vertical,\n        reports_to: {\n            engineering_lead: engineeringLead !== resourceName ? engineeringLead : null,\n            coe_manager: coeManager,\n            engineering_head: engineeringHead,\n            director: director\n        },\n        is_lead_or_manager: isLeadOrManagerRole\n    };\n    \n    // Build natural language descriptions for better LLM understanding\n    \n    // 1. Role description\n    let roleDescription = `${resourceName} is a ${roleCategory}`;\n    if (globalSeniority) {\n        roleDescription += ` with ${globalSeniority} seniority`;\n    }\n    if (isLeadOrManagerRole) {\n        roleDescription += ` in a leadership position`;\n    }\n    if (primarySkillAreas.length > 0) {\n        roleDescription += ` specializing in ${primarySkillAreas.slice(0, 2).join(' and ')}`;\n    }\n    roleDescription += `.`;\n    \n    // 2. Skills description\n    let skillsDescription = \"\";\n    \n    if (skills.senior.length > 0) {\n        skillsDescription += `Has senior-level expertise in ${skills.senior.join(', ')}.`;\n    }\n    \n    if (skills.mid.length > 0) {\n        skillsDescription += ` Proficient in ${skills.mid.join(', ')}.`;\n    }\n    \n    if (skills.junior.length > 0) {\n        skillsDescription += ` Also familiar with ${skills.junior.join(', ')}.`;\n    }\n    \n    // 3. Industry description\n    let industryDescription = \"\";\n    if (industries.length > 0) {\n        industryDescription = `Has experience in the following industries: ${industries.join(', ')}.`;\n    }\n    \n    // 4. Organizational context\n    let orgDescription = \"\";\n    if (team || department || vertical) {\n        orgDescription = `Works in ${team || 'the company'}`;\n        if (department) {\n            orgDescription += `, part of ${department}`;\n        }\n        if (vertical) {\n            orgDescription += ` within the ${vertical} vertical`;\n        }\n        orgDescription += '.';\n    }\n    \n    // 5. Management chain\n    let managementDescription = \"\";\n    if (coeManager || engineeringLead || engineeringHead || director) {\n        const managers = [];\n        if (engineeringLead && engineeringLead !== resourceName) managers.push(`Engineering Lead: ${engineeringLead}`);\n        if (coeManager) managers.push(`COE Manager: ${coeManager}`);\n        if (engineeringHead) managers.push(`Engineering Head: ${engineeringHead}`);\n        if (director) managers.push(`Director: ${director}`);\n        \n        if (managers.length > 0) {\n            managementDescription = `Reports to ${managers.join(', ')}.`;\n        }\n    }\n    \n    // 6. Domain knowledge, technical tools and certificates\n    let expertiseDescription = \"\";\n    \n    if (technicalDetails.tools.length > 0 || \n        technicalDetails.technologies.length > 0 || \n        technicalDetails.methodologies.length > 0) {\n        \n        if (technicalDetails.tools.length > 0) {\n            expertiseDescription += `Experienced with tools: ${technicalDetails.tools.join(', ')}. `;\n        }\n        \n        if (technicalDetails.technologies.length > 0) {\n            expertiseDescription += `Familiar with technologies: ${technicalDetails.technologies.join(', ')}. `;\n        }\n        \n        if (technicalDetails.methodologies.length > 0) {\n            expertiseDescription += `Follows methodologies: ${technicalDetails.methodologies.join(', ')}. `;\n        }\n    }\n    \n    if (domainKnowledge) {\n        expertiseDescription += `Domain knowledge: ${domainKnowledge} `;\n    }\n    \n    if (certificatesList.length > 0) {\n        expertiseDescription += `Holds certifications in: ${certificatesList.join(', ')}.`;\n    }\n    \n    // 7. Create conversation-friendly search text\n    // This is optimized for natural language questions to the LLM\n    const conversationText = `\n    ${roleDescription}\n    ${skillsDescription}\n    ${industryDescription}\n    ${orgDescription}\n    ${managementDescription}\n    ${expertiseDescription}\n    ${note ? 'Additional info: ' + note : ''}\n    `.trim();\n    \n    // 8. Create structured embedding text (for vector search)\n    const structuredParts = [];\n    \n    // Start with name, technical domain and role category\n    structuredParts.push(`${technicalDomain}, ${roleCategory}, ${globalSeniority}, ${employment_type}`);\n    \n    // Add team info\n    // if (team || department || vertical) {\n    //     structuredParts.push(`Organization: ${vertical || ''} | ${department || ''} | ${team || ''}`);\n    // }\n    \n    // Add management\n    // if (coeManager || engineeringLead || engineeringHead || director) {\n    //     structuredParts.push(`Management: ${engineeringLead !== resourceName ? engineeringLead : ''} | ${coeManager} | ${engineeringHead} | ${director}`);\n    // }\n    \n    // Add primary skill areas\n    if (primarySkillAreas.length > 0) {\n        structuredParts.push(`${primarySkillAreas.join(', ')}`);\n    }\n    \n    // Add skills by level\n    if (skills.senior.length > 0) {\n        structuredParts.push(`${skills.senior.join(', ')}`);\n    }\n    \n    if (skills.mid.length > 0) {\n        structuredParts.push(`${skills.mid.join(', ')}`);\n    }\n    \n    if (skills.junior.length > 0) {\n        structuredParts.push(`${skills.junior.join(', ')}`);\n    }\n    \n    // Add industries\n    if (industries.length > 0) {\n        structuredParts.push(`${industries.join(', ')}`);\n    }\n    \n    // Add extracted tools and technologies\n    if (technicalDetails.tools.length > 0) {\n        structuredParts.push(`${technicalDetails.tools.join(', ')}`);\n    }\n    \n    if (technicalDetails.technologies.length > 0) {\n        structuredParts.push(`${technicalDetails.technologies.join(', ')}`);\n    }\n    \n    if (technicalDetails.methodologies.length > 0) {\n        structuredParts.push(`${technicalDetails.methodologies.join(', ')}`);\n    }\n    \n    // Add certificates\n    if (certificatesList.length > 0) {\n        structuredParts.push(`${certificatesList.join(', ')}`);\n    }\n    \n    // Add miscellaneous notes if present\n    if (note && note.trim()) {\n        structuredParts.push(`${note}`);\n    }\n    \n    // Join with pipe separator\n    const structuredText = structuredParts.filter(Boolean).join(', ');\n    \n    // Full text for embedding combines structured and natural language\n    const textToEmbed = `${structuredText} | ${conversationText}`;\n\n  const nameToEmail = (name) => {\n  if (!name) return null;\n  \n  // Normalize Croatian characters\n  const normalize = (str) => {\n    return str\n      .toLowerCase()\n      .replace(/Ä/g, 'c')\n      .replace(/Ä‡/g, 'c')\n      .replace(/Ä‘/g, 'd')\n      .replace(/Å¡/g, 's')\n      .replace(/Å¾/g, 'z');\n  };\n  \n  const parts = name.trim().split(/\\s+/);\n  \n  if (parts.length === 1) {\n    // Single name: zlatko@q.agency\n    return `${normalize(parts[0])}@q.agency`;\n  } else if (parts.length === 2) {\n    // Two words: zlatko.matokanovic@q.agency\n    return `${normalize(parts[0])}.${normalize(parts[1])}@q.agency`;\n  } else {\n    // Three+ words: first.restjoinedtogether@q.agency\n    const first = normalize(parts[0]);\n    const rest = parts.slice(1).map(p => normalize(p)).join('');\n    return `${first}.${rest}@q.agency`;\n  }\n};\n  \n  return {\n    json: {\n        id: resourceId,\n        name: resourceName,\n        role: role,\n        primary_skill: primary_skill,\n        section: section,\n        skills_senior: skills_senior,\n        skills_medium: skills_medium,\n        skills_junior: skills_junior,\n        industry: industries,\n        description: description,\n        seniority: seniority,\n        team:team,\n        department:department,\n        vertical:vertical,\n        coe_manager:coe_manager,\n        el:el,\n        eh:eh,\n        director:director,\n        employment_type:employment_type,\n        certs: certs,\n        note: note,\n      email: nameToEmail(resourceName)\n        // embedding_text: embeddingText,\n    }\n  };\n});"
      },
      "id": "d6abfcfa-3b96-4adf-b24d-6ec52e2e18c0",
      "name": "Process Resources",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2448,
        1536
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=TRUNCATE TABLE \n  public.resource_facts,\n  public.ganttic_api_resources\n;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3216,
        1536
      ],
      "id": "cba79312-6f19-4470-a972-93ef2acc6fab",
      "name": "Truncate Resources",
      "credentials": {
        "postgres": {
          "id": "wK2pSCG9jTniRU28",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "number": [
            {
              "name": "page",
              "value": "={{$json[\"next_page\"] || 1}}"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Res Page",
      "type": "n8n-nodes-base.set",
      "position": [
        -2960,
        1536
      ],
      "typeVersion": 1,
      "id": "e68622a1-dd09-453f-84d8-72c52584dce3"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $('Set Res Page').last().json.page }}",
              "value2": "={{ $('Fetch Ganttic Resources').last().json.pageCount }}"
            }
          ]
        }
      },
      "name": "More Res Pages?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1792,
        1536
      ],
      "id": "fe983c24-ede5-4d5c-80cc-22c3265f0bb1"
    },
    {
      "parameters": {
        "values": {
          "number": [
            {
              "name": "next_page",
              "value": "={{ $('Set Res Page').item.json.page + 1 }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Increment Res Page",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -1344,
        1520
      ],
      "id": "17f409dd-d4ab-4537-b937-2a7290b17b90"
    },
    {
      "parameters": {
        "amount": 0.3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -1568,
        1520
      ],
      "id": "65f21b1c-7c66-4d31-a1d9-1c022702af30",
      "name": "Wait Res",
      "webhookId": "34f21572-31a2-4c5b-a08a-d4be2e33651d"
    },
    {
      "parameters": {
        "jsCode": "return {\n  \"json\": {\n    \"success\": true\n  }\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1568,
        1744
      ],
      "id": "3f522a52-1934-4e49-9883-f4f838cdb8d7",
      "name": "Code"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1344,
        1744
      ],
      "id": "5f3663f9-1f9a-4038-b1f5-4a5987475244",
      "name": "Respond to Webhook3"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "resources_refresh_dataset",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3520,
        1536
      ],
      "id": "ac0d8e2c-baf7-41bd-b914-b9b9fdb46b92",
      "name": "Sync Ganttic",
      "webhookId": "80ec34df-e777-4086-a430-c72ab0144f4f"
    },
    {
      "parameters": {
        "resource": "user",
        "operation": "getAll",
        "returnAll": true
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -1424,
        1072
      ],
      "id": "622bc442-6da4-4b64-9e7d-090f0d3d1ee9",
      "name": "Get many users",
      "webhookId": "1334d91d-adf3-4aee-9cfb-7a86dd94e3b8",
      "credentials": {
        "slackApi": {
          "id": "ZmOgvDTEw8iOSljK",
          "name": "Slack AIHub"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const users = $input.all();\n\nconst activeUsers = users.filter(item => {\n  const user = item.json;\n  return !user.deleted \n    && !user.is_bot \n    && !user.is_app_user \n    && user.id !== 'USLACKBOT';  // Exclude Slackbot specifically\n});\n\nreturn activeUsers;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1216,
        1072
      ],
      "id": "806c5fc7-9871-470e-a2db-5beb710549f0",
      "name": "Only valid"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "slack_users",
          "mode": "list",
          "cachedResultName": "slack_users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{ $json.email }}",
            "name": "={{ $json.name }}",
            "image": "={{ $json.image }}"
          },
          "matchingColumns": [
            "email"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "image",
              "displayName": "image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -800,
        1072
      ],
      "id": "f39895d1-f2de-45a1-ae15-d61fbef9e8fc",
      "name": "Insert or update rows in a table",
      "credentials": {
        "postgres": {
          "id": "wK2pSCG9jTniRU28",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COALESCE(\n  (SELECT image FROM slack_users \n   WHERE LOWER(TRANSLATE(\n           REGEXP_REPLACE(email, '[^a-zA-ZÄŒÄÄ†Ä‡ÄÄ‘Å Å¡Å½Å¾ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÅƒÅ„ÃÃ½Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹Ã‚Ã¢ÃŠÃªÃÃ®Ã”Ã´Ã›Ã»Ã‹Ã«ÃÃ¯ÃœÃ¼Å¸Ã¿0-9.@]', '', 'g'),\n           'ÄŒÄÄ†Ä‡ÄÄ‘Å Å¡Å½Å¾ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÅƒÅ„ÃÃ½Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹Ã‚Ã¢ÃŠÃªÃÃ®Ã”Ã´Ã›Ã»Ã‹Ã«ÃÃ¯ÃœÃ¼Å¸Ã¿', \n           'CcCcDdSsZzAaEeIiOoUuNnYyAaEeIiOoUuAaEeIiOoUuEeIiUuYy'\n         )) \n       = \n         LOWER(TRANSLATE(\n           REGEXP_REPLACE('{{ $json.email }}', '[^a-zA-ZÄŒÄÄ†Ä‡ÄÄ‘Å Å¡Å½Å¾ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÅƒÅ„ÃÃ½Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹Ã‚Ã¢ÃŠÃªÃÃ®Ã”Ã´Ã›Ã»Ã‹Ã«ÃÃ¯ÃœÃ¼Å¸Ã¿0-9.@]', '', 'g'),\n           'ÄŒÄÄ†Ä‡ÄÄ‘Å Å¡Å½Å¾ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÅƒÅ„ÃÃ½Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹Ã‚Ã¢ÃŠÃªÃÃ®Ã”Ã´Ã›Ã»Ã‹Ã«ÃÃ¯ÃœÃ¼Å¸Ã¿', \n           'CcCcDdSsZzAaEeIiOoUuNnYyAaEeIiOoUuAaEeIiOoUuEeIiUuYy'\n         ))\n  ),\n  null\n) AS image_url;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2224,
        1536
      ],
      "id": "b3a24e99-e5a7-4609-8148-92204a607df1",
      "name": "Get image url1",
      "credentials": {
        "postgres": {
          "id": "wK2pSCG9jTniRU28",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7ef3a103-75aa-464a-a0c6-b9c1d6da03c3",
              "name": "name",
              "value": "={{ $json.real_name }}",
              "type": "string"
            },
            {
              "id": "abef7551-a0a0-4616-b83d-69201c6705b2",
              "name": "email",
              "value": "={{ $json.profile.email }}",
              "type": "string"
            },
            {
              "id": "b11993aa-813e-418c-8a25-0ca20cfa1865",
              "name": "image",
              "value": "={{ $json.profile.image_192 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1008,
        1072
      ],
      "id": "9e4b7bbd-dc30-458d-9430-13d16f39b8da",
      "name": "Get image links"
    },
    {
      "parameters": {
        "content": "## Get Slack Images\n \n",
        "height": 320,
        "width": 1120
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1616,
        960
      ],
      "id": "1d6f4cf1-1873-4b28-bdf6-a0f0e2fcab58",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Search Resources\n\n",
        "height": 336,
        "width": 1552,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3648,
        544
      ],
      "id": "9a9e7338-f748-4a22-a4fa-5bdea2dcb1a0",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Get Filters\n\n\n",
        "height": 336,
        "width": 1552,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3648,
        944
      ],
      "id": "0e9c1799-a2ca-48b5-9319-7514ef2b1468",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Sync Ganttic\n\n\n",
        "height": 528,
        "width": 2768,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3648,
        1440
      ],
      "id": "eb9b3caa-06db-4688-a0e9-e0e4e49d7bc4",
      "name": "Sticky Note3"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "infinite-wasp-terminally.ngrok-free.app",
            "user-agent": "Slackbot 1.0 (+https://api.slack.com/robots)",
            "content-length": "1006",
            "accept": "*/*",
            "accept-encoding": "gzip,deflate",
            "content-type": "application/json",
            "x-forwarded-for": "34.230.52.77",
            "x-forwarded-host": "infinite-wasp-terminally.ngrok-free.app",
            "x-forwarded-proto": "https",
            "x-slack-request-timestamp": "1764589239",
            "x-slack-signature": "v0=cf35f51b1a3fe1d259eed0b34f82e7d79f4701889c0930e062e83c4f6e1ea4ae"
          },
          "params": {},
          "query": {},
          "body": {
            "token": "IlfX9mvC2nzNKpe8lFzBgFqQ",
            "team_id": "T02RA2KBP",
            "context_team_id": "T02RA2KBP",
            "context_enterprise_id": null,
            "api_app_id": "A08K4AP899A",
            "event": {
              "type": "message",
              "user": "U9S2GLSPL",
              "ts": "1764589238.588659",
              "client_msg_id": "bd3891b7-b992-43ca-a74f-991edfd46f01",
              "text": "find me senior 1 react developer who knows angular and worked in finance",
              "team": "T02RA2KBP",
              "blocks": [
                {
                  "type": "rich_text",
                  "block_id": "J87cr",
                  "elements": [
                    {
                      "type": "rich_text_section",
                      "elements": [
                        {
                          "type": "text",
                          "text": "find me senior 1 react developer who knows angular and worked in finance"
                        }
                      ]
                    }
                  ]
                }
              ],
              "channel": "D08KMTGN96U",
              "event_ts": "1764589238.588659",
              "channel_type": "im"
            },
            "type": "event_callback",
            "event_id": "Ev0A1L6ESQ0Y",
            "event_time": 1764589238,
            "authorizations": [
              {
                "enterprise_id": null,
                "team_id": "T02RA2KBP",
                "user_id": "U08JTRGVD6J",
                "is_bot": true,
                "is_enterprise_install": false
              }
            ],
            "is_ext_shared_channel": false,
            "event_context": "4-eyJldCI6Im1lc3NhZ2UiLCJ0aWQiOiJUMDJSQTJLQlAiLCJhaWQiOiJBMDhLNEFQODk5QSIsImNpZCI6IkQwOEtNVEdOOTZVIn0"
          },
          "webhookUrl": "https://infinite-wasp-terminally.ngrok-free.app/webhook/knowledge",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo_name": "n8n-backup-zm",
  "repo_owner": "zlatkomq",
  "repo_path": "",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-09-29T11:07:48.915Z",
      "createdAt": "2025-09-29T11:07:48.915Z",
      "role": "workflow:owner",
      "workflowId": "oiDh643KBesTwbL7",
      "projectId": "NM7VZoSXkcKo262s"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 4,
  "updatedAt": "2025-12-10T09:01:11.495Z",
  "versionId": "2e78ed06-f33a-4124-a343-cb8fcd7e5452"
}